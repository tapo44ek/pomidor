2025-02-11 12:06:49,942 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,942 - INFO - Params: None
2025-02-11 12:06:49,944 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,944 - INFO - Params: None
2025-02-11 12:06:57,862 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 12:06:57,862 - INFO - РќР°С‡Р°Р»Рѕ Р·Р°РіСЂСѓР·РєРё С„Р°Р№Р»Р°
2025-02-11 12:06:57,862 - INFO - Р¤Р°Р№Р» РґР»СЏ Р·Р°РіСЂСѓР·РєРё: ./uploads/container_46.xlsx
2025-02-11 12:06:57,862 - INFO - Р¤Р°Р№Р» РїРѕРґРіРѕС‚РѕРІР»РµРЅ: {'file': ('container_46.xlsx', <_io.BufferedReader name='./uploads/container_46.xlsx'>, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')}
2025-02-11 12:06:57,880 - ERROR - РџСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР°: HTTPConnectionPool(host='webspd.mlc.gov', port=80): Max retries exceeded with url: /SpdRemote/spdremotemvc/MassStart/Parse (Caused by NameResolutionError("<urllib3.connection.HTTPConnection object at 0x787bb6026b60>: Failed to resolve 'webspd.mlc.gov' ([Errno -5] No address associated with hostname)"))
2025-02-11 14:10:50,051 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:14,343 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:33,113 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:46,398 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:13:15,916 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:14:59,871 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:15:26,384 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:17:07,660 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:21:04,342 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:22:06,282 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:23:46,092 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:24:10,693 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:27:00,721 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-12 19:09:13,935 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 19:09:13,935 - INFO - Params: {}
2025-02-12 19:09:14,326 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: отношение "old_apart" не существует
[SQL: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 19:09:50,907 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 19:09:50,907 - INFO - Params: {}
2025-02-12 19:09:59,722 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 19:09:59,722 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 19:10:05,789 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 19:10:05,789 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 19:10:16,511 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 19:10:16,512 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1}
2025-02-12 19:10:16,534 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND room_count IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Гражданская 3-я ул., д.21', 1)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 19:14:09,386 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 19:14:09,386 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1}
2025-02-12 19:14:09,420 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: отношение "family_structure" не существует
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND room_count IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Гражданская 3-я ул., д.21', 1)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:31:49,618 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 20:31:49,618 - INFO - Params: None
2025-02-12 20:31:50,063 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:34:14,430 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 20:34:14,430 - INFO - Params: {}
2025-02-12 20:34:15,433 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 20:34:15,433 - INFO - Params: {}
2025-02-12 20:35:21,645 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 20:35:21,646 - INFO - Params: None
2025-02-12 20:35:21,666 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:35:21,995 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 20:35:21,995 - INFO - Params: {}
2025-02-12 20:35:22,729 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 20:35:22,729 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 20:35:23,306 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:23,306 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 20:35:23,384 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:23,384 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 20:35:23,732 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:23,732 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:25,316 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:25,316 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:25,630 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:25,631 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-12 20:35:26,027 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:26,027 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:34,880 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:34,880 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.3', 'municipal_0': 'Богородское'}
2025-02-12 20:35:35,519 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:35,519 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-12 20:35:35,964 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:35,964 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:36,367 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:36,367 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 20:35:36,417 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:36,417 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 20:35:36,849 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:36,849 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-12 20:35:36,850 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:36,850 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-12 20:35:38,280 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:38,280 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-12 20:35:38,281 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:38,282 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-12 20:35:39,442 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 20:35:39,442 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-12 20:36:09,903 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 20:36:09,903 - INFO - Params: {}
2025-02-12 20:36:10,058 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 20:36:10,058 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-12 20:36:10,420 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 20:36:10,420 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-12 20:36:11,024 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:36:11,024 - INFO - Params: {'municipal_districts_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,026 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:36:11,026 - INFO - Params: {'municipal_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,281 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:36:11,281 - INFO - Params: {'municipal_districts_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,386 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Внуковское сельское поселение',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:11,429 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:36:11,429 - INFO - Params: {'municipal_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,503 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Внуковское сельское поселение',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:11,696 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:36:11,696 - INFO - Params: {'municipal_districts_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:11,770 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:36:11,770 - INFO - Params: {'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:12,001 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Воскресенское сельское поселение',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:12,667 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:36:12,667 - INFO - Params: {'house_address_0': 'Чечерский пр. (п.Воскресенское), д.122 кор.1', 'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:12,710 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Чечерский пр. (п.Воскресенское), д.122 кор.1', 'Воскресенское сельское поселение')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:13,826 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:36:13,826 - INFO - Params: {'house_address_0': 'Чечерский пр. (п.Воскресенское), д.122 кор.1', 'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:13,880 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Чечерский пр. (п.Воскресенское), д.122 кор.1', 'Воскресенское сельское поселение')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:14,077 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:36:14,077 - INFO - Params: {'house_address_0': 'Чечерский пр. (п.Воскресенское), д.122 кор.1', 'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:14,103 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Чечерский пр. (п.Воскресенское), д.122 кор.1', 'Воскресенское сельское поселение')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 21:20:15,082 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 21:20:15,082 - INFO - Params: {}
2025-02-12 21:20:15,083 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.InterfaceError) <class 'asyncpg.exceptions._base.InterfaceError'>: connection is closed
[SQL: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/rvf5)
2025-02-12 21:21:16,165 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 21:21:16,165 - INFO - Params: {}
2025-02-12 21:22:16,173 - ERROR - Error executing query: 
2025-02-13 10:05:58,425 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:05:58,426 - INFO - Params: None
2025-02-13 10:05:58,906 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:05:59,659 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:05:59,659 - INFO - Params: {}
2025-02-13 10:06:02,934 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:06:02,934 - INFO - Params: None
2025-02-13 10:06:02,955 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:03,572 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:06:03,572 - INFO - Params: {}
2025-02-13 10:06:05,363 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:06:05,363 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:06:05,924 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:06:05,924 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 10:06:05,925 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:06:05,925 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:06,369 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:06:06,369 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.1', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:07,413 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 10:06:07,413 - INFO - Params: {}
2025-02-13 10:06:08,114 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:06:08,114 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 10:06:08,770 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:06:08,770 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 10:06:08,771 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:08,771 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 10:06:09,117 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:09,117 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 10:06:10,384 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:10,384 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.7', 'municipal_0': 'Крылатское'}
2025-02-13 10:06:18,441 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 10:06:18,441 - INFO - Params: {}
2025-02-13 10:06:18,712 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:06:18,712 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 10:06:19,224 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:06:19,224 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:06:20,056 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:06:20,056 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 10:06:20,057 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:20,057 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:20,436 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:06:20,436 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 10:06:20,502 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:20,502 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 10:06:21,292 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:21,292 - INFO - Params: {'house_address_0': 'Парковая 13-я ул., д.16А', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:21,801 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:21,802 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:21,874 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:22,516 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:22,516 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:22,580 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:22,865 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:22,865 - INFO - Params: {'apart_id': 8876888}
2025-02-13 10:06:22,936 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:23,453 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:23,453 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:23,524 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:23,716 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:23,717 - INFO - Params: {'apart_id': 8876888}
2025-02-13 10:06:23,783 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:23,927 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:23,927 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:23,992 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:24,267 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8877026
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:24,267 - INFO - Params: {'apart_id': 8877026}
2025-02-13 10:06:24,340 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8877026
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:24,756 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:24,756 - INFO - Params: {'apart_id': 8876888}
2025-02-13 10:06:24,824 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:09:14,493 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876957
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:09:14,493 - INFO - Params: {'apart_id': 8876957}
2025-02-13 10:09:14,571 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876957
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:09:50,036 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:09:50,036 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:09:50,560 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:09:50,561 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:09:50,629 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:50,629 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:51,101 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:51,101 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:52,338 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:52,338 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:53,932 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:53,932 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:55,271 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:55,271 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:58,755 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:09:58,755 - INFO - Params: None
2025-02-13 10:09:58,773 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:13:13,466 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:13:13,466 - INFO - Params: {}
2025-02-13 10:13:13,738 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 10:13:13,738 - INFO - Params: {}
2025-02-13 10:13:14,829 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:13:14,830 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 10:13:16,044 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:13:16,044 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:13:16,437 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:13:16,437 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:13:16,438 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:16,438 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:17,911 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:17,911 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:18,828 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:18,829 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:19,108 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:19,108 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:20,035 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:20,035 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:21,743 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:21,743 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:49,322 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:49,322 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:58,719 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:58,719 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:59,038 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:59,038 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:01,206 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:14:01,206 - INFO - Params: {}
2025-02-13 10:14:02,688 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:14:02,688 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:14:03,168 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:14:03,168 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 10:14:03,598 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:14:03,598 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:14:03,765 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:03,766 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:04,085 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:04,085 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:05,902 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:05,902 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:08,220 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:08,220 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 34, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:10,199 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:10,199 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:43:48,620 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:43:48,620 - INFO - Params: None
2025-02-13 14:43:49,076 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:43:49,976 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:43:49,976 - INFO - Params: {}
2025-02-13 14:43:51,117 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:43:51,118 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 14:43:51,461 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:43:51,462 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 14:43:51,525 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:43:51,526 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 14:43:52,260 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:43:52,260 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 14:43:52,261 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:43:52,261 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 14:43:52,778 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:43:52,778 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 14:44:04,605 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 14:44:04,605 - INFO - Params: {}
2025-02-13 14:44:04,814 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:44:04,814 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 14:44:05,354 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:05,354 - INFO - Params: {'municipal_districts_0': 'Кунцево'}
2025-02-13 14:44:05,355 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:05,355 - INFO - Params: {'municipal_0': 'Кунцево'}
2025-02-13 14:44:05,843 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:05,843 - INFO - Params: {'house_address_0': 'Бобруйская ул., д.15/1', 'municipal_0': 'Кунцево'}
2025-02-13 14:44:07,122 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:07,122 - INFO - Params: {'house_address_0': 'Ельнинская ул., д.14 кор.2', 'municipal_0': 'Кунцево'}
2025-02-13 14:44:11,248 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:11,248 - INFO - Params: {'municipal_districts_0': 'Кунцево'}
2025-02-13 14:44:11,295 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:11,296 - INFO - Params: {'municipal_0': 'Кунцево'}
2025-02-13 14:44:12,906 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:44:12,906 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:44:13,201 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:44:13,201 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:44:15,124 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:15,124 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:15,124 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:15,125 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:16,173 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:16,173 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:17,890 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:17,890 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:19,285 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:19,285 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:22,809 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:22,810 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:22,859 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:22,859 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:23,242 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:23,242 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:23,323 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:23,323 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:24,320 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:24,320 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:24,741 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:24,741 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:25,456 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:25,456 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:26,555 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:26,555 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:26,556 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:26,557 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:11,865 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:47:11,865 - INFO - Params: None
2025-02-13 14:47:11,892 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:47:22,398 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:47:22,399 - INFO - Params: {}
2025-02-13 14:47:23,929 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:47:23,930 - INFO - Params: {}
2025-02-13 14:47:24,035 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 14:47:24,035 - INFO - Params: {}
2025-02-13 14:47:24,761 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:47:24,761 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:47:25,494 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:47:25,494 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:47:25,496 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:25,496 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:26,052 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:26,052 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:27,439 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:27,439 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:28,335 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:28,335 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:29,505 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:29,505 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:30,569 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:30,570 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:01,540 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:48:01,540 - INFO - Params: {}
2025-02-13 14:48:02,629 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:02,629 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:48:03,367 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:48:03,367 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:48:03,368 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:03,368 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:04,568 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:04,569 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:04,811 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:04,811 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:06,951 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 14:48:06,951 - INFO - Params: {}
2025-02-13 14:48:07,691 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:07,692 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:48:08,058 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:08,058 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 14:48:08,480 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:48:08,481 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:48:08,523 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:48:08,523 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:08,846 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:48:08,846 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:16,451 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:48:16,452 - INFO - Params: {}
2025-02-13 14:48:17,452 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:17,452 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:48:17,918 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:48:17,918 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:48:17,980 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:17,980 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:19,173 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:19,173 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:50,134 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:48:50,134 - INFO - Params: None
2025-02-13 14:48:50,136 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:48:50,136 - INFO - Params: {}
2025-02-13 14:48:50,956 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:50:53,405 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:50:53,405 - INFO - Params: None
2025-02-13 14:50:53,432 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:57:55,507 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:57:55,508 - INFO - Params: None
2025-02-13 14:57:55,535 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:02:35,485 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:02:35,486 - INFO - Params: None
2025-02-13 15:02:35,506 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:02:39,010 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 15:02:39,010 - INFO - Params: {}
2025-02-13 15:02:40,720 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:02:40,720 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 15:02:41,247 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:02:41,247 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 15:02:41,834 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:02:41,834 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:02:41,925 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:02:41,926 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:02:43,211 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:02:43,211 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 15:02:50,573 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:02:50,573 - INFO - Params: None
2025-02-13 15:02:50,596 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:02:51,196 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 15:02:51,196 - INFO - Params: {}
2025-02-13 15:02:51,590 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 15:02:51,590 - INFO - Params: {}
2025-02-13 15:02:52,886 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:02:52,886 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 15:02:53,446 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:02:53,446 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:02:53,520 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 15:02:53,520 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:02:53,965 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 15:02:53,965 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 15:14:36,834 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:14:36,834 - INFO - Params: None
2025-02-13 15:14:36,870 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:14:46,078 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:14:46,078 - INFO - Params: None
2025-02-13 15:14:46,101 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:50:00,734 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 15:50:00,734 - INFO - Params: {}
2025-02-13 15:50:01,081 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:50:01,082 - INFO - Params: None
2025-02-13 15:50:01,102 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:50:30,864 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:50:30,864 - INFO - Params: None
2025-02-13 15:50:30,897 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:06:43,383 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:06:43,384 - INFO - Params: {}
2025-02-13 16:07:35,221 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:07:35,221 - INFO - Params: {}
2025-02-13 16:07:35,735 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:07:35,736 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:07:38,534 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:07:38,534 - INFO - Params: {}
2025-02-13 16:07:38,948 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:07:38,948 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:07:39,416 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:07:39,416 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 16:07:39,417 - INFO - Executing query: 
2025-02-13 16:07:39,418 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:07:39,753 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:07:54,859 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:07:54,859 - INFO - Params: {}
2025-02-13 16:07:55,787 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:07:55,787 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:07:56,294 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:07:56,295 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:07:56,296 - INFO - Executing query: 
2025-02-13 16:07:56,296 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:07:56,323 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:07:56,766 - INFO - Executing query: 
2025-02-13 16:07:56,766 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:07:56,786 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:07:58,223 - INFO - Executing query: 
2025-02-13 16:07:58,223 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:07:58,262 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:25,946 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:25,946 - INFO - Params: {'municipal_districts_0': 'Восточный'}
2025-02-13 16:08:26,020 - INFO - Executing query: 
2025-02-13 16:08:26,020 - INFO - Params: {'municipal_0': 'Восточный'}
2025-02-13 16:08:26,045 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:26,677 - INFO - Executing query: 
2025-02-13 16:08:26,677 - INFO - Params: {'house_address_0': 'Акулово пос., д.14', 'municipal_0': 'Восточный'}
2025-02-13 16:08:26,690 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:27,675 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:08:27,675 - INFO - Params: {}
2025-02-13 16:08:27,945 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:08:27,945 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 16:08:28,544 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:28,544 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:08:28,546 - INFO - Executing query: 
2025-02-13 16:08:28,546 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:28,597 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:29,064 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:29,064 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:08:29,107 - INFO - Executing query: 
2025-02-13 16:08:29,107 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:29,128 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:29,604 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:29,604 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:08:29,648 - INFO - Executing query: 
2025-02-13 16:08:29,649 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:29,661 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:29,929 - INFO - Executing query: 
2025-02-13 16:08:29,929 - INFO - Params: {'house_address_0': 'Солнечная аллея кор.934', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:29,941 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:14:53,606 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:14:53,607 - INFO - Params: {}
2025-02-13 16:15:01,685 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:15:01,685 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:15:07,257 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:15:07,257 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:15:18,419 - INFO - Executing query: 
2025-02-13 16:15:18,419 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:15:18,440 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:19:52,249 - INFO - Executing query: 
2025-02-13 16:19:52,249 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:19:52,660 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:20:47,619 - INFO - Executing query: 
2025-02-13 16:20:47,619 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:20:48,029 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:20:48,029 - ERROR - 
2025-02-13 16:21:57,695 - INFO - Executing query: 
2025-02-13 16:21:57,695 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:21:58,368 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:21:58,368 - ERROR - 
2025-02-13 16:23:29,337 - INFO - Executing query: 
2025-02-13 16:23:29,337 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:23:29,741 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:23:29,741 - ERROR - 
2025-02-13 16:30:14,471 - INFO - Executing query: 
2025-02-13 16:30:14,471 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:30:14,899 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:30:14,900 - ERROR - 
2025-02-13 16:42:07,303 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:42:07,304 - INFO - Params: {}
2025-02-13 16:42:08,965 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:42:08,965 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:42:09,474 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:42:09,474 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:42:09,475 - INFO - Executing query: where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:09,475 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:42:09,750 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where municipal_district IN ($1) AND rn = 1]
[parameters: ('Богородское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:09,751 - ERROR - where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:09,962 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:09,962 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:42:09,982 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Кузнецовская ул., д.7', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:09,982 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,377 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,377 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:42:11,408 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Кузнецовская ул., д.7', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:11,408 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,642 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,643 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:42:11,669 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Кузнецовская ул., д.7', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:11,669 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:05,339 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:43:05,339 - INFO - Params: {}
2025-02-13 16:43:06,614 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:43:06,614 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:43:07,261 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:43:07,261 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 16:43:07,263 - INFO - Executing query: where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:07,263 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:07,508 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where municipal_district IN ($1) AND rn = 1]
[parameters: ('Восточное Измайлово',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:07,508 - ERROR - where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:07,767 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:07,767 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.1', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:07,786 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Измайловский бульв., д.71/25 кор.1', 'Восточное Измайлово')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:07,786 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:09,044 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:09,044 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.1', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:09,062 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Измайловский бульв., д.71/25 кор.1', 'Восточное Измайлово')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:09,062 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:40,379 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:40,380 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.2', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:40,494 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:43:40,494 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 16:43:40,795 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:40,795 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:40,938 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Измайловский бульв., д.71/25 кор.2', 'Восточное Измайлово')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:40,938 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,055 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Восточное Измайлово',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:41,055 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,155 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,155 - INFO - Params: {'municipal_0': 'Гольяново'}
2025-02-13 16:43:41,227 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Гольяново',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:41,227 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,447 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:43:41,447 - INFO - Params: {'municipal_districts_0': 'Гольяново'}
2025-02-13 16:43:42,171 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:42,171 - INFO - Params: {'house_address_0': 'Амурская ул., д.26', 'municipal_0': 'Гольяново'}
2025-02-13 16:43:42,190 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Амурская ул., д.26', 'Гольяново')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:42,190 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:49,491 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:49,491 - INFO - Params: {'house_address_0': 'Амурская ул., д.32', 'municipal_0': 'Гольяново'}
2025-02-13 16:47:49,921 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Амурская ул., д.32', 'Гольяново')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:49,921 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:50,000 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:47:50,000 - INFO - Params: {}
2025-02-13 16:47:50,746 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:47:50,746 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:47:51,594 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:47:51,594 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:47:51,664 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:51,664 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:47:51,683 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Богородское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:51,683 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:51,941 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:51,942 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-13 16:47:51,962 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.2', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:51,962 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:53,064 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:53,064 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-13 16:47:53,086 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.2', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:53,086 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,134 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:48:09,134 - INFO - Params: {'municipal_districts_0': 'Ивановское'}
2025-02-13 16:48:09,208 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,208 - INFO - Params: {'municipal_0': 'Ивановское'}
2025-02-13 16:48:09,236 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Ивановское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:48:09,236 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,449 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,449 - INFO - Params: {'house_address_0': 'Зеленый просп., д.101', 'municipal_0': 'Ивановское'}
2025-02-13 16:48:09,469 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Зеленый просп., д.101', 'Ивановское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:48:09,469 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:03,132 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:54:03,132 - INFO - Params: {'municipal_districts_0': 'Ивановское'}
2025-02-13 16:54:03,135 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:03,136 - INFO - Params: {'municipal_0': 'Ивановское'}
2025-02-13 16:54:03,392 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:54:03,392 - INFO - Params: {'municipal_districts_0': 'Косино-Ухтомский'}
2025-02-13 16:54:03,492 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:03,492 - INFO - Params: {'municipal_0': 'Косино-Ухтомский'}
2025-02-13 16:54:03,905 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Ивановское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:03,905 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:04,091 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Косино-Ухтомский',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:04,091 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:04,471 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:04,471 - INFO - Params: {'house_address_0': 'Камова ул., д.3', 'municipal_0': 'Косино-Ухтомский'}
2025-02-13 16:54:04,490 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Камова ул., д.3', 'Косино-Ухтомский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:04,490 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:06,428 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:54:06,428 - INFO - Params: {}
2025-02-13 16:54:07,371 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:54:07,371 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:54:07,820 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:54:07,820 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:54:07,822 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:07,822 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:54:07,861 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Богородское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:07,861 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:08,346 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:08,346 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-13 16:54:08,363 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.2', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:08,364 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:45,984 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:45,984 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.3', 'municipal_0': 'Богородское'}
2025-02-13 16:54:46,345 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.3', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:46,345 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:13,702 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:13,702 - INFO - Params: {'municipal_0': 'Восточный'}
2025-02-13 16:55:13,705 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:55:13,705 - INFO - Params: {'municipal_districts_0': 'Восточный'}
2025-02-13 16:55:14,059 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Восточный',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:55:14,060 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:14,880 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:14,880 - INFO - Params: {'house_address_0': 'Акулово пос., д.13', 'municipal_0': 'Восточный'}
2025-02-13 16:55:14,912 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Акулово пос., д.13', 'Восточный')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:55:14,912 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:57:44,265 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:44,265 - INFO - Params: {'house_address_0': 'Акулово пос., д.14', 'municipal_0': 'Восточный'}
2025-02-13 16:57:45,019 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:57:45,019 - INFO - Params: {}
2025-02-13 16:57:48,385 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:57:48,385 - INFO - Params: {}
2025-02-13 16:57:48,936 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:57:48,936 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:57:49,423 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:57:49,423 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:57:49,424 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:49,424 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:57:49,840 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:49,840 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:57:51,462 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:51,462 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:57:52,072 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:57:52,073 - INFO - Params: {}
2025-02-13 16:57:52,972 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:57:52,973 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:57:53,350 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:57:53,350 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:57:53,351 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:57:53,351 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:57:53,842 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:57:53,842 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'municipal_0': 'Богородское'}
2025-02-13 16:57:58,167 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:57:58,167 - INFO - Params: {}
2025-02-13 16:57:58,737 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:57:58,737 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 16:57:59,675 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:57:59,675 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 16:57:59,735 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:59,735 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 16:58:00,055 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:00,056 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 16:58:00,894 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:00,894 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 16:58:07,804 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:07,804 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.7', 'municipal_0': 'NaN'}
2025-02-13 16:58:14,302 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:14,304 - INFO - Params: {'house_address_0': 'поселение Рязановское, посёлок Остафьево, д.7', 'municipal_0': 'NaN'}
2025-02-13 16:58:14,578 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:14,578 - INFO - Params: {'house_address_0': 'поселение Рязановское, посёлок Остафьево, д.7', 'municipal_0': 'NaN'}
2025-02-13 16:58:24,010 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:24,010 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 16:58:24,079 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:24,079 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 16:58:24,868 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:58:24,868 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 16:58:25,294 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:25,294 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 16:58:25,295 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:25,295 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 16:58:25,827 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:25,827 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 16:58:33,467 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:58:33,467 - INFO - Params: {}
2025-02-13 16:58:33,756 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:58:33,756 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 16:58:34,272 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:34,272 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:58:34,273 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:34,273 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:35,121 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:35,121 - INFO - Params: {'house_address_0': 'Зеленоград г. кор.848', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:36,937 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:36,937 - INFO - Params: {'house_address_0': 'Солнечная аллея кор.934', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:41,036 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:41,036 - INFO - Params: {'house_address_0': 'Зеленоград г. кор.848', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:50,570 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:50,570 - INFO - Params: {'house_address_0': 'Солнечная аллея кор.934', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:51,530 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:51,530 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:58:51,531 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:51,531 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 17:00:24,179 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:00:24,179 - INFO - Params: None
2025-02-13 17:00:24,203 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:00:27,136 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:00:27,136 - INFO - Params: None
2025-02-13 17:00:27,154 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:00:27,371 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:00:27,371 - INFO - Params: {}
2025-02-13 17:00:29,796 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:00:29,796 - INFO - Params: {}
2025-02-13 17:00:30,224 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:00:30,224 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:00:30,709 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:00:30,709 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 17:00:30,709 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:00:30,710 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 17:00:31,885 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:00:31,885 - INFO - Params: {'house_address_0': 'Парковая 13-я ул., д.16А', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 17:00:32,205 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:00:32,205 - INFO - Params: {'house_address_0': 'Парковая 13-я ул., д.16А', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 17:00:40,320 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:00:40,320 - INFO - Params: {}
2025-02-13 17:01:34,542 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:01:34,542 - INFO - Params: {}
2025-02-13 17:01:35,197 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:01:35,197 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:01:35,844 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:01:35,844 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:01:35,900 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:01:35,900 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:01:36,278 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:01:36,278 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:01:55,452 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:01:55,452 - INFO - Params: {}
2025-02-13 17:01:56,058 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:01:56,058 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 17:01:57,029 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:01:57,029 - INFO - Params: {'municipal_districts_0': 'Крюково'}
2025-02-13 17:01:57,077 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:01:57,077 - INFO - Params: {'municipal_0': 'Крюково'}
2025-02-13 17:01:57,410 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:01:57,410 - INFO - Params: {'house_address_0': 'Георгиевский пр-т кор.1934', 'municipal_0': 'Крюково'}
2025-02-13 17:01:58,798 - INFO - Executing query: 
2025-02-13 17:01:58,798 - INFO - Params: {'apart_id': 8867006}
2025-02-13 17:01:58,821 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 17:01:59,735 - INFO - Executing query: 
2025-02-13 17:01:59,735 - INFO - Params: {'apart_id': 8867006}
2025-02-13 17:01:59,765 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 17:02:25,954 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1, :room_2) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:02:25,954 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 17:02:42,384 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:02:42,384 - INFO - Params: {}
2025-02-13 17:02:42,909 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:02:42,910 - INFO - Params: {}
2025-02-13 17:02:50,749 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:02:50,750 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:02:55,051 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:02:55,051 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:02:56,751 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:02:56,751 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:03:03,597 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1, :room_2) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:03:03,597 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 17:03:08,223 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:03:08,223 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1, 'room_1': 2}
2025-02-13 17:04:19,863 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:04:19,863 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1, 'room_1': 2}
2025-02-13 17:05:04,989 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:04,990 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7'}
2025-02-13 17:05:09,493 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:09,493 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1}
2025-02-13 17:05:12,508 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:12,508 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1}
2025-02-13 17:05:32,519 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:32,519 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1}
2025-02-13 17:05:50,381 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:50,382 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7'}
2025-02-13 17:06:09,968 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and room_count IN (:room_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:06:09,969 - INFO - Params: {'room_0': 1}
2025-02-13 17:07:07,940 - INFO - Executing query: 
2025-02-13 17:07:07,940 - INFO - Params: {'apart_id': 8866992}
2025-02-13 17:07:08,351 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 17:07:08,564 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:07:08,565 - INFO - Params: {}
2025-02-13 17:07:09,384 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:07:09,384 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:07:09,809 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:07:09,809 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:07:09,874 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:09,874 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 17:07:10,282 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:10,283 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:07:13,307 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:13,308 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.3', 'municipal_0': 'Богородское'}
2025-02-13 17:07:14,441 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:07:14,441 - INFO - Params: {'municipal_districts_0': 'Измайлово'}
2025-02-13 17:07:14,446 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:14,446 - INFO - Params: {'municipal_0': 'Измайлово'}
2025-02-13 17:07:14,908 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:14,909 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.15', 'municipal_0': 'Измайлово'}
2025-02-13 17:10:03,831 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:10:03,831 - INFO - Params: {}
2025-02-13 17:10:04,991 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:04,991 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:05,572 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:05,572 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:05,577 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:05,577 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:06,021 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:06,021 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:09,068 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:10:09,068 - INFO - Params: None
2025-02-13 17:10:09,102 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:10:13,441 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:10:13,441 - INFO - Params: {}
2025-02-13 17:10:14,116 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:10:14,116 - INFO - Params: {}
2025-02-13 17:10:15,488 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:15,488 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:16,229 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:16,229 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:16,233 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:16,234 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:17,758 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:17,758 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:19,404 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:19,404 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:46,077 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:10:46,077 - INFO - Params: None
2025-02-13 17:10:46,104 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:10:51,030 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:10:51,030 - INFO - Params: {}
2025-02-13 17:10:51,927 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:10:51,927 - INFO - Params: {}
2025-02-13 17:10:52,902 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:52,903 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:53,306 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:53,306 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:10:53,786 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:53,786 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:53,833 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:53,833 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:54,225 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:54,225 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:56,607 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:10:56,607 - INFO - Params: {}
2025-02-13 17:10:57,510 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:57,510 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:58,208 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:58,208 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:58,212 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:10:58,212 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:58,559 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:10:58,559 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:04,333 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:11:04,333 - INFO - Params: None
2025-02-13 17:11:04,366 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:11:47,202 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:11:47,202 - INFO - Params: {}
2025-02-13 17:11:47,848 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:11:47,849 - INFO - Params: {}
2025-02-13 17:11:48,300 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:11:48,300 - INFO - Params: {}
2025-02-13 17:11:49,054 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:11:49,054 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:11:49,458 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:49,458 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:11:49,463 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:49,463 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:11:49,973 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:49,973 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:11:51,861 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:11:51,861 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:11:52,257 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:52,257 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:11:52,262 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:52,262 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:11:52,729 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:52,729 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:11:53,364 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:53,364 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:11:54,206 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:11:54,206 - INFO - Params: {}
2025-02-13 17:11:54,672 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:11:54,672 - INFO - Params: {}
2025-02-13 17:11:55,356 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:11:55,356 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:11:56,722 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:56,722 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:11:56,727 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:56,727 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:58,224 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:58,225 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:58,425 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:58,425 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:59,853 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:59,853 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:11:59,857 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:59,857 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:12:01,774 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:12:01,774 - INFO - Params: {}
2025-02-13 17:12:02,424 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:12:02,424 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:12:02,757 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:12:02,757 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:12:02,762 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:12:02,762 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 17:12:03,393 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:12:03,393 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'municipal_0': 'Богородское'}
2025-02-13 17:12:49,081 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:12:49,081 - INFO - Params: {}
2025-02-13 17:12:49,083 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:12:49,083 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:12:50,413 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:12:50,413 - INFO - Params: {'municipal_districts_0': 'Кунцево'}
2025-02-13 17:12:50,417 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:50,417 - INFO - Params: {'municipal_0': 'Кунцево'}
2025-02-13 17:12:50,911 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:50,912 - INFO - Params: {'house_address_0': 'Екатерины Будановой ул., д.22', 'municipal_0': 'Кунцево'}
2025-02-13 17:12:53,288 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:53,288 - INFO - Params: {'house_address_0': 'Екатерины Будановой ул., д.22', 'municipal_0': 'Кунцево'}
2025-02-13 17:12:53,877 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:53,877 - INFO - Params: {'house_address_0': 'Ивана Франко ул., д.18 кор.1', 'municipal_0': 'Кунцево'}
2025-02-13 17:13:06,903 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:13:06,903 - INFO - Params: {'house_address_0': 'Ивана Франко ул., д.22 кор.4', 'municipal_0': 'Кунцево'}
2025-02-13 17:13:07,624 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:13:07,624 - INFO - Params: {'municipal_districts_0': 'Раменки'}
2025-02-13 17:13:07,628 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:13:07,629 - INFO - Params: {'municipal_0': 'Раменки'}
2025-02-13 17:14:31,561 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:31,561 - INFO - Params: {'house_address_0': 'Коцюбинского ул., д.8 кор.1', 'municipal_0': 'Кунцево'}
2025-02-13 17:14:31,965 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Коцюбинского ул., д.8 кор.1', 'Кунцево')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:33,046 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:14:33,046 - INFO - Params: {}
2025-02-13 17:14:33,992 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:14:33,992 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:14:34,405 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:14:34,406 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 17:14:34,481 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:34,481 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 17:14:34,513 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "municipal_district")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('NaN',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:34,877 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:34,877 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 17:14:34,900 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('1-я Железнодорожная улица, д.6', 'NaN')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:36,432 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:14:36,432 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:14:36,577 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:14:36,577 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:14:39,152 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:14:39,152 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:14:39,157 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:39,157 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:39,496 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "municipal_district")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Алтуфьевский',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:39,592 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:39,592 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:39,620 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Инженерная ул., дом 10, корп. 1', 'Алтуфьевский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:40,803 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:40,803 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:40,832 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Инженерная ул., дом 10, корп. 1', 'Алтуфьевский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:41,289 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:41,289 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:41,309 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Инженерная ул., дом 10, корп. 1', 'Алтуфьевский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:16:34,660 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:16:34,660 - INFO - Params: {}
2025-02-13 17:16:34,665 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:34,665 - INFO - Params: {'house_address_0': 'поселение Рязановское, посёлок Остафьево, д.7', 'municipal_0': 'NaN'}
2025-02-13 17:16:35,502 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:16:35,502 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:16:35,918 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:16:35,918 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:16:36,032 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:36,032 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:16:36,468 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:36,468 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:16:37,939 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:16:37,939 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:16:38,269 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:16:38,269 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:16:38,274 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:38,274 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:38,692 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:38,692 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:49,221 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:49,221 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:50,070 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:50,070 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 20, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:50,922 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:16:50,922 - INFO - Params: {'district_0': 'Московская область'}
2025-02-13 17:16:51,370 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:16:51,370 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:16:51,375 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:51,375 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:16:51,801 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:51,801 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:16:53,581 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:53,581 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:17:25,751 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:17:25,751 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:17:25,757 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:17:25,757 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:17:25,759 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:17:25,759 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:17:25,761 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:17:25,761 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-13 17:17:26,502 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:17:26,502 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:17:26,621 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:17:26,621 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:18:10,385 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:10,386 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:18:10,774 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:18:10,774 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:18:10,779 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:10,779 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:18:12,143 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:18:12,143 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 17:18:13,470 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:18:13,470 - INFO - Params: {'municipal_districts_0': 'Крюково'}
2025-02-13 17:18:13,475 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:13,475 - INFO - Params: {'municipal_0': 'Крюково'}
2025-02-13 17:18:13,944 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:13,944 - INFO - Params: {'house_address_0': 'Зеленоград, Заводская ул. (Крюково), д.10', 'municipal_0': 'Крюково'}
2025-02-13 17:20:54,022 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:20:54,022 - INFO - Params: {'house_address_0': 'Зеленоград, Заводская ул. (Крюково), д.12Б', 'municipal_0': 'Крюково'}
2025-02-13 17:22:14,158 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:22:14,158 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:22:14,992 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:22:14,992 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:22:14,997 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:14,997 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:15,360 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:15,360 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:17,620 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:22:17,620 - INFO - Params: None
2025-02-13 17:22:17,786 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:22:22,073 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:22:22,073 - INFO - Params: {}
2025-02-13 17:22:22,978 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:22:22,978 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:22:23,344 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:22:23,344 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:22:23,348 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:23,349 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:23,745 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:23,745 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:43,320 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:22:43,320 - INFO - Params: None
2025-02-13 17:22:43,339 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:25:00,794 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:25:00,794 - INFO - Params: None
2025-02-13 17:25:00,819 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:30:55,074 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:30:55,074 - INFO - Params: None
2025-02-13 17:30:55,106 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:02,986 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:31:02,986 - INFO - Params: {}
2025-02-13 17:31:04,227 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:04,227 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:31:05,055 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:31:05,055 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:31:05,118 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:05,119 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:05,439 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:05,439 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:07,588 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:07,588 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:08,650 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:08,650 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:08,942 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:08,942 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:09,386 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:09,386 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:09,762 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:09,762 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:10,174 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:10,174 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:10,521 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:10,521 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:10,932 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:10,932 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:11,306 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:11,306 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:20,806 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:20,806 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:21,519 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:21,520 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 20, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:40,739 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:31:40,740 - INFO - Params: {}
2025-02-13 17:31:41,556 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:41,557 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:31:41,869 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:41,869 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:31:42,367 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:31:42,367 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:31:42,371 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:31:42,371 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:42,752 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:31:42,753 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:44,158 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:31:44,159 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:45,415 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:31:45,415 - INFO - Params: {}
2025-02-13 17:31:46,203 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:46,203 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:31:46,922 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:31:46,922 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:31:46,927 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:46,927 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:47,193 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:47,193 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:48,868 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:48,868 - INFO - Params: None
2025-02-13 17:31:48,896 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:51,412 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:51,412 - INFO - Params: None
2025-02-13 17:31:51,430 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:52,753 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:52,753 - INFO - Params: None
2025-02-13 17:31:52,772 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:55,080 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:55,080 - INFO - Params: None
2025-02-13 17:31:55,107 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:32:07,856 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:32:07,856 - INFO - Params: {}
2025-02-13 17:32:09,178 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:32:09,178 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:32:09,569 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:32:09,569 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:32:10,083 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:32:10,083 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:32:10,150 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:32:10,150 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:32:10,662 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:32:10,662 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:24,982 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:24,983 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:33:24,999 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:24,999 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:27,107 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:33:27,107 - INFO - Params: {}
2025-02-13 17:33:27,967 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:33:27,967 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:33:28,803 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:28,803 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:33:28,808 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:28,809 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:29,222 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:29,222 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:30,191 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:30,191 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:30,896 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:33:30,896 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:33:32,069 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:32,069 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:33:32,074 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:32,074 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:33:32,379 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:32,379 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:33:36,315 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:36,315 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:33:36,744 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:36,744 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:33:38,291 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:38,291 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:33:38,296 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:38,296 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:33:38,718 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:38,719 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:33:38,724 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:38,724 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:33:51,782 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:51,782 - INFO - Params: {'house_address_0': 'Рейсовая 1-я ул., д.7', 'municipal_0': 'Внуково'}
2025-02-13 17:33:58,599 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:58,600 - INFO - Params: {'house_address_0': 'Рейсовая 2-я ул., д.12', 'municipal_0': 'Внуково'}
2025-02-13 17:33:59,141 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:59,142 - INFO - Params: {'house_address_0': 'Рейсовая 2-я ул., д.12', 'municipal_0': 'Внуково'}
2025-02-13 17:34:30,777 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:30,777 - INFO - Params: {'house_address_0': 'Рейсовая 2-я ул., д.14', 'municipal_0': 'Внуково'}
2025-02-13 17:34:32,167 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:32,167 - INFO - Params: {'house_address_0': 'Аэрофлотская ул., д.3', 'municipal_0': 'Внуково'}
2025-02-13 17:34:32,997 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:34:32,998 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:34:34,046 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:34:34,046 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:34:34,050 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:34,050 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:34:34,640 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:34,641 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:34:35,474 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:35,475 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:34:35,747 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:35,748 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:34:36,153 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:34:36,153 - INFO - Params: {}
2025-02-13 17:34:36,534 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:34:36,534 - INFO - Params: {}
2025-02-13 17:34:37,308 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:34:37,308 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:34:37,981 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:34:37,981 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:34:37,985 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:37,985 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 17:34:38,361 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:38,361 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:34:43,387 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:43,387 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:34:43,660 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:43,660 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:36:03,919 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:36:03,920 - INFO - Params: {}
2025-02-13 17:36:06,426 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:36:06,426 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:36:06,927 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:06,927 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:36:06,932 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:06,932 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:36:07,332 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:07,332 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:36:10,886 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:36:10,886 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 17:36:11,738 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:11,738 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 17:36:11,742 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:11,743 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 17:36:12,497 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:12,497 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 17:36:13,736 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:13,736 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.7', 'municipal_0': 'NaN'}
2025-02-13 17:36:14,323 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:14,323 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.8', 'municipal_0': 'NaN'}
2025-02-13 17:36:15,224 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:15,224 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 17:36:15,228 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:15,228 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 17:36:16,730 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:16,730 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:36:16,734 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:16,734 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:36:18,225 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:36:18,225 - INFO - Params: {}
2025-02-13 17:36:18,975 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:36:18,975 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:36:19,486 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:19,487 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 17:36:19,492 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:36:19,492 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 17:36:19,879 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:36:19,879 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 17:36:21,811 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:36:21,811 - INFO - Params: None
2025-02-13 17:36:21,845 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:36:59,842 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:36:59,842 - INFO - Params: {}
2025-02-13 17:37:00,360 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:00,360 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:37:00,781 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:37:00,782 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:37:00,787 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:00,787 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:37:01,247 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:01,247 - INFO - Params: {'house_address_0': 'Аэрофлотская ул., д.3', 'municipal_0': 'Внуково'}
2025-02-13 17:37:04,818 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:04,818 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:37:05,253 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:37:05,253 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:37:05,257 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:05,257 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:37:06,571 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:06,571 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:37:48,205 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:37:48,205 - INFO - Params: {}
2025-02-13 17:37:49,929 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:49,929 - INFO - Params: {'district_0': 'Московская область'}
2025-02-13 17:37:50,408 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:50,408 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-13 17:37:50,683 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:37:50,683 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:37:50,686 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:50,686 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:37:51,192 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:51,193 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:43:00,205 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:43:00,205 - INFO - Params: {}
2025-02-13 17:43:01,294 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:43:01,294 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:43:01,619 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:43:01,619 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:43:01,623 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:01,623 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:43:02,134 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:02,134 - INFO - Params: {'house_address_0': 'Аэрофлотская ул., д.3', 'municipal_0': 'Внуково'}
2025-02-13 17:43:16,152 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:43:16,152 - INFO - Params: {}
2025-02-13 17:43:18,466 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:43:18,466 - INFO - Params: {'district_0': 'Московская область'}
2025-02-13 17:43:18,879 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:43:18,879 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:43:18,885 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:18,885 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:43:19,367 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:19,367 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:43:49,669 - INFO - Executing query: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;

2025-02-13 17:43:49,669 - INFO - Params: {'apart_id': 848354}
2025-02-13 17:43:49,735 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "{")
[SQL: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;
]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:44:10,822 - INFO - Executing query: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;

2025-02-13 17:44:10,822 - INFO - Params: {'apart_id': 848356}
2025-02-13 17:44:10,898 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "{")
[SQL: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;
]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:44:16,331 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:44:16,331 - INFO - Params: {}
2025-02-13 17:44:17,275 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:44:17,275 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:44:17,588 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:44:17,589 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 17:44:17,593 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:44:17,593 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 17:44:18,021 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:44:18,021 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 17:44:18,756 - INFO - Executing query: 
2025-02-13 17:44:18,756 - INFO - Params: {'apart_id': 8776712}
2025-02-13 17:44:18,781 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 19:31:30,815 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 19:31:30,815 - INFO - Params: {}
2025-02-13 19:31:31,656 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:31:31,656 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 19:31:32,965 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:31:32,965 - INFO - Params: {'municipal_districts_0': 'Крюково'}
2025-02-13 19:31:32,968 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:31:32,969 - INFO - Params: {'municipal_0': 'Крюково'}
2025-02-13 19:31:33,434 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:31:33,435 - INFO - Params: {'house_address_0': 'Зеленоград, Заводская ул. (Крюково), д.10', 'municipal_0': 'Крюково'}
2025-02-13 19:31:34,867 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where :affair_id = 948533
            ORDER BY 
                new_apartments;
2025-02-13 19:31:34,867 - INFO - Params: {'apart_id': 948533}
2025-02-13 19:31:34,868 - ERROR - Error executing query: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'affair_id'
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where $1 = 948533
            ORDER BY 
                new_apartments;]
[parameters: [{'apart_id': 948533}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-02-13 19:31:37,589 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where :affair_id = 948550
            ORDER BY 
                new_apartments;
2025-02-13 19:31:37,589 - INFO - Params: {'apart_id': 948550}
2025-02-13 19:31:37,590 - ERROR - Error executing query: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'affair_id'
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where $1 = 948550
            ORDER BY 
                new_apartments;]
[parameters: [{'apart_id': 948550}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-02-13 19:31:38,165 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where :affair_id = 948537
            ORDER BY 
                new_apartments;
2025-02-13 19:31:38,165 - INFO - Params: {'apart_id': 948537}
2025-02-13 19:31:38,166 - ERROR - Error executing query: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'affair_id'
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where $1 = 948537
            ORDER BY 
                new_apartments;]
[parameters: [{'apart_id': 948537}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-02-13 19:33:59,078 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948521
            ORDER BY 
                new_apartments;
2025-02-13 19:33:59,078 - INFO - Params: {'apart_id': 948521}
2025-02-13 19:33:59,378 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948550
            ORDER BY 
                new_apartments;
2025-02-13 19:33:59,378 - INFO - Params: {'apart_id': 948550}
2025-02-13 19:33:59,708 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948521
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:33:59,912 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948550
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:37,716 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948524
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:37,716 - INFO - Params: {'apart_id': 948524}
2025-02-13 19:34:38,023 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948550
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:38,023 - INFO - Params: {'apart_id': 948550}
2025-02-13 19:34:38,332 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948524
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:38,565 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948550
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:38,724 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948533
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:38,724 - INFO - Params: {'apart_id': 948533}
2025-02-13 19:34:38,800 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948533
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:40,215 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 19:34:40,215 - INFO - Params: {}
2025-02-13 19:34:42,512 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:34:42,512 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 19:34:43,037 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:34:43,037 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 19:34:43,126 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:43,126 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 19:34:43,451 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:43,451 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 19:34:44,057 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:44,057 - INFO - Params: {'apart_id': 960267}
2025-02-13 19:34:44,117 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:49,302 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:49,302 - INFO - Params: {'apart_id': 960267}
2025-02-13 19:34:49,402 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:52,848 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:34:52,849 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 19:34:53,295 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:34:53,295 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 19:34:53,303 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:53,303 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 19:34:53,743 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:53,743 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 19:34:55,355 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:55,355 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 19:34:56,424 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:56,424 - INFO - Params: {'apart_id': 85624691}
2025-02-13 19:34:56,492 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:57,578 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624698
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:57,578 - INFO - Params: {'apart_id': 85624698}
2025-02-13 19:34:57,660 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624698
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:35:17,213 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624670
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:35:17,214 - INFO - Params: {'apart_id': 85624670}
2025-02-13 19:35:18,315 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 19:35:18,315 - INFO - Params: {}
2025-02-13 19:35:20,384 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:35:20,384 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 19:35:20,821 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:35:20,821 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 19:35:20,826 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:35:20,826 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 19:35:21,230 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:35:21,230 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 19:35:22,012 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 900727
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:35:22,012 - INFO - Params: {'apart_id': 900727}
2025-02-13 21:59:45,573 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 21:59:45,573 - INFO - Params: {}
2025-02-13 21:59:45,845 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:45,845 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 21:59:47,476 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:47,476 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 21:59:47,952 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:47,952 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 21:59:47,957 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:47,957 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 21:59:48,439 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:48,439 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 21:59:49,371 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 8776722
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 21:59:49,371 - INFO - Params: {'apart_id': 8776722}
2025-02-13 21:59:50,956 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 8776712
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 21:59:50,956 - INFO - Params: {'apart_id': 8776712}
2025-02-13 21:59:51,594 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 8776722
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 21:59:51,594 - INFO - Params: {'apart_id': 8776722}
2025-02-13 21:59:54,941 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:54,941 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 21:59:55,379 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:55,379 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:55,385 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:55,385 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:55,844 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:55,844 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:55,923 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:55,923 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:57,012 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:57,012 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:57,016 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:57,016 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:57,344 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:57,345 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:57,426 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:57,427 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:58,066 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:58,066 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 22:00:00,388 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:00:00,388 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:00:00,393 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:00:00,393 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:01,058 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:00:01,058 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:03,487 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:00:03,487 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:04,344 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54545
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:04,344 - INFO - Params: {'apart_id': 54545}
2025-02-13 22:00:06,534 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54650
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:06,534 - INFO - Params: {'apart_id': 54650}
2025-02-13 22:00:07,292 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55106
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:07,293 - INFO - Params: {'apart_id': 55106}
2025-02-13 22:00:08,403 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54601
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:08,403 - INFO - Params: {'apart_id': 54601}
2025-02-13 22:00:23,866 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 22:00:23,866 - INFO - Params: {}
2025-02-13 22:00:25,563 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:00:25,563 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:00:26,025 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:00:26,025 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:00:26,030 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:00:26,030 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:27,573 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:00:27,573 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:33,935 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624682
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:00:33,935 - INFO - Params: {'apart_id': 85624682}
2025-02-13 22:00:34,027 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "anser_date" не существует
HINT:  Возможно, предполагалась ссылка на столбец "lft.answer_date".
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624682
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 22:00:46,095 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:00:46,095 - INFO - Params: {'apart_id': 85624691}
2025-02-13 22:00:46,160 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "anser_date" не существует
HINT:  Возможно, предполагалась ссылка на столбец "lft.answer_date".
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 22:00:47,076 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624670
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:00:47,076 - INFO - Params: {'apart_id': 85624670}
2025-02-13 22:00:47,146 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "anser_date" не существует
HINT:  Возможно, предполагалась ссылка на столбец "lft.answer_date".
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624670
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 22:01:34,604 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624707
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:01:34,604 - INFO - Params: {'apart_id': 85624707}
2025-02-13 22:01:35,079 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624678
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:01:35,079 - INFO - Params: {'apart_id': 85624678}
2025-02-13 22:01:35,788 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:01:35,788 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:36,484 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:01:36,484 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:38,528 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 22:01:38,528 - INFO - Params: {}
2025-02-13 22:01:39,234 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:01:39,234 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:01:39,744 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:01:39,744 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:01:39,749 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:01:39,749 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:40,320 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:01:40,320 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:41,890 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54503
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:01:41,890 - INFO - Params: {'apart_id': 54503}
2025-02-13 22:02:32,162 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54650
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:02:32,163 - INFO - Params: {'apart_id': 54650}
2025-02-13 22:03:11,531 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54594
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:11,531 - INFO - Params: {'apart_id': 54594}
2025-02-13 22:03:11,899 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54587
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:11,899 - INFO - Params: {'apart_id': 54587}
2025-02-13 22:03:12,535 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55064
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:12,535 - INFO - Params: {'apart_id': 55064}
2025-02-13 22:03:13,226 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55029
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:13,226 - INFO - Params: {'apart_id': 55029}
2025-02-13 22:03:14,640 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54781
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:14,641 - INFO - Params: {'apart_id': 54781}
2025-02-13 22:03:15,652 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54980
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:15,653 - INFO - Params: {'apart_id': 54980}
2025-02-13 22:03:16,275 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55085
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:16,275 - INFO - Params: {'apart_id': 55085}
2025-02-13 22:03:17,430 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54538
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:17,430 - INFO - Params: {'apart_id': 54538}
2025-02-13 22:04:43,894 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54793
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:43,894 - INFO - Params: {'apart_id': 54793}
2025-02-13 22:04:46,249 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54994
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:46,249 - INFO - Params: {'apart_id': 54994}
2025-02-13 22:04:47,088 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55099
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:47,089 - INFO - Params: {'apart_id': 55099}
2025-02-13 22:04:47,650 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54538
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:47,650 - INFO - Params: {'apart_id': 54538}
2025-02-13 22:04:49,830 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 22:04:49,830 - INFO - Params: {}
2025-02-13 22:04:51,026 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:04:51,026 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:04:51,788 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:04:51,788 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:04:51,792 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:04:51,792 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:04:52,627 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:04:52,627 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:04:54,067 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624722
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:04:54,067 - INFO - Params: {'apart_id': 85624722}
2025-02-13 22:04:56,912 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85625054
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:04:56,912 - INFO - Params: {'apart_id': 85625054}
2025-02-13 22:04:58,987 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 22:04:58,987 - INFO - Params: {}
2025-02-13 22:05:00,420 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:05:00,420 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:05:01,441 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:05:01,441 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:05:01,523 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:05:01,523 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:05:01,916 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:05:01,916 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:05:04,078 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54503
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:04,078 - INFO - Params: {'apart_id': 54503}
2025-02-13 22:05:05,465 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54615
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:05,465 - INFO - Params: {'apart_id': 54615}
2025-02-13 22:05:06,125 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54601
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:06,125 - INFO - Params: {'apart_id': 54601}
2025-02-13 22:05:06,552 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54573
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:06,552 - INFO - Params: {'apart_id': 54573}
2025-02-13 22:05:07,266 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54608
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:07,266 - INFO - Params: {'apart_id': 54608}
2025-02-13 22:05:08,003 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55001
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:08,004 - INFO - Params: {'apart_id': 55001}
2025-02-13 22:05:08,676 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55022
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:08,676 - INFO - Params: {'apart_id': 55022}
2025-02-13 22:05:09,350 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54973
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:09,350 - INFO - Params: {'apart_id': 54973}
2025-02-13 22:05:10,041 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54829
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:10,041 - INFO - Params: {'apart_id': 54829}
2025-02-13 22:05:10,689 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54769
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:10,690 - INFO - Params: {'apart_id': 54769}
2025-02-13 22:05:11,377 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54841
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:11,377 - INFO - Params: {'apart_id': 54841}
2025-02-13 22:05:12,175 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54804
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:12,175 - INFO - Params: {'apart_id': 54804}
2025-02-13 22:05:12,841 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54507
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:12,841 - INFO - Params: {'apart_id': 54507}
2025-02-13 22:05:13,522 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54647
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:13,522 - INFO - Params: {'apart_id': 54647}
2025-02-13 22:05:14,110 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54556
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:14,110 - INFO - Params: {'apart_id': 54556}
2025-02-13 22:05:14,676 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55027
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:14,676 - INFO - Params: {'apart_id': 55027}
2025-02-13 22:05:15,222 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55069
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:15,222 - INFO - Params: {'apart_id': 55069}
2025-02-13 22:05:15,785 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55013
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:15,785 - INFO - Params: {'apart_id': 55013}
2025-02-13 22:05:16,325 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54803
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:16,325 - INFO - Params: {'apart_id': 54803}
2025-02-13 22:05:16,901 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54809
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:16,901 - INFO - Params: {'apart_id': 54809}
2025-02-13 22:05:35,767 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54845
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:35,767 - INFO - Params: {'apart_id': 54845}
2025-02-13 22:07:16,659 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54809 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:07:16,659 - INFO - Params: {'apart_id': 54809}
2025-02-13 22:07:18,212 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54761 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:07:18,213 - INFO - Params: {'apart_id': 54761}
2025-02-13 22:07:25,442 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54809 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:07:25,442 - INFO - Params: {'apart_id': 54809}
2025-02-13 22:17:48,862 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54845 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:17:48,862 - INFO - Params: {'apart_id': 54845}
2025-02-13 22:17:50,643 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 22:17:50,643 - INFO - Params: {}
2025-02-13 22:17:52,372 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:17:52,372 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:17:52,850 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:17:52,850 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 22:17:53,429 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:17:53,429 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:17:53,434 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:17:53,434 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:17:53,977 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:17:53,977 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:17:56,246 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 22:17:56,246 - INFO - Params: {}
2025-02-13 22:18:00,371 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:18:00,371 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:18:01,131 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:18:01,131 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:18:01,205 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-13 22:18:01,206 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:18:01,568 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-13 22:18:01,569 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
