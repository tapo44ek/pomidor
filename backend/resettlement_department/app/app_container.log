2025-02-11 12:06:49,942 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,942 - INFO - Params: None
2025-02-11 12:06:49,944 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,944 - INFO - Params: None
2025-02-11 12:06:57,862 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 12:06:57,862 - INFO - РќР°С‡Р°Р»Рѕ Р·Р°РіСЂСѓР·РєРё С„Р°Р№Р»Р°
2025-02-11 12:06:57,862 - INFO - Р¤Р°Р№Р» РґР»СЏ Р·Р°РіСЂСѓР·РєРё: ./uploads/container_46.xlsx
2025-02-11 12:06:57,862 - INFO - Р¤Р°Р№Р» РїРѕРґРіРѕС‚РѕРІР»РµРЅ: {'file': ('container_46.xlsx', <_io.BufferedReader name='./uploads/container_46.xlsx'>, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')}
2025-02-11 12:06:57,880 - ERROR - РџСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР°: HTTPConnectionPool(host='webspd.mlc.gov', port=80): Max retries exceeded with url: /SpdRemote/spdremotemvc/MassStart/Parse (Caused by NameResolutionError("<urllib3.connection.HTTPConnection object at 0x787bb6026b60>: Failed to resolve 'webspd.mlc.gov' ([Errno -5] No address associated with hostname)"))
2025-02-11 14:10:50,051 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:14,343 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:33,113 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:46,398 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:13:15,916 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:14:59,871 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:15:26,384 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:17:07,660 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:21:04,342 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:22:06,282 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:23:46,092 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:24:10,693 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:27:00,721 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-12 19:09:13,935 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 19:09:13,935 - INFO - Params: {}
2025-02-12 19:09:14,326 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: отношение "old_apart" не существует
[SQL: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 19:09:50,907 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 19:09:50,907 - INFO - Params: {}
2025-02-12 19:09:59,722 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 19:09:59,722 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 19:10:05,789 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 19:10:05,789 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 19:10:16,511 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 19:10:16,512 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1}
2025-02-12 19:10:16,534 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND room_count IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Гражданская 3-я ул., д.21', 1)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 19:14:09,386 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 19:14:09,386 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1}
2025-02-12 19:14:09,420 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: отношение "family_structure" не существует
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND room_count IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Гражданская 3-я ул., д.21', 1)]
(Background on this error at: https://sqlalche.me/e/20/f405)
