2025-02-11 12:06:49,942 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,942 - INFO - Params: None
2025-02-11 12:06:49,944 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,944 - INFO - Params: None
2025-02-11 12:06:57,862 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 12:06:57,862 - INFO - –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
2025-02-11 12:06:57,862 - INFO - –§–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏: ./uploads/container_46.xlsx
2025-02-11 12:06:57,862 - INFO - –§–∞–π–ª –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω: {'file': ('container_46.xlsx', <_io.BufferedReader name='./uploads/container_46.xlsx'>, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')}
2025-02-11 12:06:57,880 - ERROR - –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: HTTPConnectionPool(host='webspd.mlc.gov', port=80): Max retries exceeded with url: /SpdRemote/spdremotemvc/MassStart/Parse (Caused by NameResolutionError("<urllib3.connection.HTTPConnection object at 0x787bb6026b60>: Failed to resolve 'webspd.mlc.gov' ([Errno -5] No address associated with hostname)"))
2025-02-11 14:10:50,051 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:11:14,343 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:11:33,113 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:11:46,398 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:13:15,916 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:14:59,871 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:15:26,384 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:17:07,660 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:21:04,342 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:22:06,282 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:23:46,092 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:24:10,693 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 14:27:00,721 - INFO - Excel —Ñ–∞–π–ª './uploads/container_46.xlsx' —Å–æ–∑–¥–∞–Ω.
2025-02-11 15:02:12,986 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:02:12,987 - INFO - Params: {}
2025-02-11 15:02:16,128 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 15:02:16,129 - INFO - Params: None
2025-02-11 15:02:16,131 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 15:02:16,132 - INFO - Params: None
2025-02-11 15:07:32,849 - INFO - Excel Ù‡ÈÎ './uploads\container_46.xlsx' ÒÓÁ‰‡Ì.
2025-02-11 15:10:22,707 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:10:22,708 - INFO - Params: {}
2025-02-11 15:10:25,318 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 15:10:25,318 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 15:10:25,726 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 15:10:25,726 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 15:10:25,728 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 15:10:25,728 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 15:46:47,720 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:46:47,721 - INFO - Params: {}
2025-02-11 15:46:54,834 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:46:54,834 - INFO - Params: {}
2025-02-11 15:46:56,697 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:46:56,698 - INFO - Params: {}
2025-02-11 15:46:59,918 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 15:46:59,918 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 15:47:00,406 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 15:47:00,406 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 15:47:00,408 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 15:47:00,408 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 15:47:06,665 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-11 15:47:13,770 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-11 15:59:42,431 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:59:42,432 - INFO - Params: {}
2025-02-11 15:59:43,230 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 15:59:43,230 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 15:59:43,630 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 15:59:43,630 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 15:59:43,635 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 15:59:43,636 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:00:41,163 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:00:41,163 - INFO - Params: {}
2025-02-11 16:00:42,686 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:00:42,686 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:00:43,702 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:00:43,702 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:00:43,704 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:00:43,704 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:00:59,263 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:00:59,263 - INFO - Params: {}
2025-02-11 16:01:03,088 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:01:03,088 - INFO - Params: {}
2025-02-11 16:01:04,462 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:01:04,462 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:01:05,182 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:01:05,182 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:01:05,183 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:01:05,183 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:01:22,797 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:01:22,797 - INFO - Params: {}
2025-02-11 16:01:25,022 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:01:25,022 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:01:25,389 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:01:25,390 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:01:25,391 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:01:25,391 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:01:35,649 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:01:35,650 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 16:01:36,325 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:01:36,325 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:01:36,326 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:01:36,326 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:03:22,143 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:03:22,143 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:03:22,144 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:03:22,144 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:03:26,199 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:03:26,199 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:03:26,201 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:03:26,201 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:03:29,327 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:03:29,327 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:03:29,328 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:03:29,328 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:03:51,994 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:03:51,994 - INFO - Params: {}
2025-02-11 16:04:02,029 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:04:02,029 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:04:02,601 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:04:02,601 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:04:02,602 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:04:02,602 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:11:55,959 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:11:55,959 - INFO - Params: {}
2025-02-11 16:11:55,960 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0, :municipal_1) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:11:55,961 - INFO - Params: {'municipal_0': '¬ÓÒÚÓ˜ÌÓÂ »ÁÏ‡ÈÎÓ‚Ó', 'municipal_1': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:12:17,695 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:12:17,695 - INFO - Params: {}
2025-02-11 16:16:16,906 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:16:16,906 - INFO - Params: {'district_0': '—Â‚ÂÌ˚È ¿Œ'}
2025-02-11 16:16:17,363 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:16:17,363 - INFO - Params: {'municipal_districts_0': '¿˝ÓÔÓÚ'}
2025-02-11 16:16:17,365 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:16:17,365 - INFO - Params: {'municipal_0': '¿˝ÓÔÓÚ'}
2025-02-11 16:16:19,451 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:16:19,451 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:16:19,971 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:16:19,971 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:16:19,972 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:16:19,972 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:18:32,185 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:18:32,186 - INFO - Params: {}
2025-02-11 16:18:33,202 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:18:33,203 - INFO - Params: {}
2025-02-11 16:18:36,268 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:18:36,268 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:18:36,843 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:18:36,843 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:18:36,844 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:18:36,845 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:18:40,032 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:18:40,032 - INFO - Params: {'apart_id': 864997}
2025-02-11 16:18:44,885 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:18:44,885 - INFO - Params: {'apart_id': 864997}
2025-02-11 16:30:54,434 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:30:54,435 - INFO - Params: {'apart_id': 864918}
2025-02-11 16:32:04,924 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:32:04,925 - INFO - Params: {}
2025-02-11 16:32:07,225 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:32:07,225 - INFO - Params: {'district_0': '—Â‚ÂÌ˚È ¿Œ'}
2025-02-11 16:32:08,072 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:32:08,072 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:32:08,584 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:32:08,585 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:32:08,586 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:32:08,586 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:32:50,675 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:32:50,675 - INFO - Params: {}
2025-02-11 16:32:53,849 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:32:53,849 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:32:54,273 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:32:54,273 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:32:54,274 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:32:54,274 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:34:52,987 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:34:52,988 - INFO - Params: {}
2025-02-11 16:34:55,162 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:34:55,162 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:34:56,017 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:34:56,018 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:34:56,019 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:34:56,019 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:39:36,400 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:39:36,400 - INFO - Params: {}
2025-02-11 16:39:38,563 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:39:38,563 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:39:39,042 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:39:39,042 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:39:39,043 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:39:39,043 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:40:18,181 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:40:18,181 - INFO - Params: {}
2025-02-11 16:40:19,540 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:40:19,540 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 16:40:19,971 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:40:19,971 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:40:19,972 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:40:19,972 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:40:52,846 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:40:52,846 - INFO - Params: {}
2025-02-11 16:40:53,275 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:40:53,276 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 16:40:53,659 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:40:53,659 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:40:53,661 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:40:53,661 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:41:25,208 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:41:25,208 - INFO - Params: {}
2025-02-11 16:41:25,612 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:41:25,612 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 16:41:26,035 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:41:26,035 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:41:26,037 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:41:26,037 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:42:16,177 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:42:16,177 - INFO - Params: {}
2025-02-11 16:42:16,893 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:42:16,893 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 16:42:17,283 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:42:17,283 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:42:17,285 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:42:17,285 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:42:49,483 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:42:49,483 - INFO - Params: {}
2025-02-11 16:42:49,910 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:42:49,910 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 16:42:50,316 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:42:50,316 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:42:50,317 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:42:50,318 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:42:50,772 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:42:50,772 - INFO - Params: {'house_address_0': ' ÛÁÌÂˆÓ‚ÒÍ‡ˇ ÛÎ., ‰.7', 'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:44:43,100 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:44:43,100 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:44:43,101 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:44:43,102 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:44:45,268 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:44:45,268 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:44:45,829 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:44:45,829 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:44:45,830 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:44:45,830 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:50:31,058 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:50:31,058 - INFO - Params: {}
2025-02-11 16:50:34,447 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:50:34,447 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-11 16:50:35,479 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:50:35,479 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:50:35,480 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:50:35,480 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:50:36,582 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:50:36,583 - INFO - Params: {'apart_id': 720420}
2025-02-11 16:50:40,230 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:50:40,230 - INFO - Params: {'apart_id': 720420}
2025-02-11 16:50:42,551 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 768980
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:50:42,551 - INFO - Params: {'apart_id': 768980}
2025-02-11 16:50:45,063 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:50:45,063 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:50:45,073 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:50:45,073 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-11 16:50:47,598 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:50:47,598 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:50:48,142 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:50:48,142 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:50:48,143 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:50:48,143 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:51:03,581 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:51:03,582 - INFO - Params: {}
2025-02-11 16:51:51,264 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:51:51,264 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-11 16:51:51,815 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:51:51,815 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:51:51,831 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:51:51,831 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-11 16:51:54,326 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:51:54,326 - INFO - Params: {'apart_id': 864587}
2025-02-11 16:52:34,001 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:52:34,001 - INFO - Params: {'apart_id': 864973}
2025-02-11 16:52:36,623 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:52:36,624 - INFO - Params: {'apart_id': 864918}
2025-02-11 16:53:23,084 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864915
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:23,084 - INFO - Params: {'apart_id': 864915}
2025-02-11 16:53:33,135 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:33,135 - INFO - Params: {'apart_id': 864997}
2025-02-11 16:53:34,624 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:34,624 - INFO - Params: {'apart_id': 865013}
2025-02-11 16:53:35,951 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:35,951 - INFO - Params: {'apart_id': 864958}
2025-02-11 16:53:37,448 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:37,448 - INFO - Params: {'apart_id': 864877}
2025-02-11 16:53:39,271 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:39,271 - INFO - Params: {'apart_id': 864919}
2025-02-11 16:53:42,319 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:42,319 - INFO - Params: {'apart_id': 864877}
2025-02-12 08:04:13,969 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:04:13,971 - INFO - Params: {}
2025-02-12 08:04:18,128 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:04:18,129 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 08:04:18,729 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:04:18,729 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:04:18,731 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:04:18,731 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:04:22,440 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:04:22,441 - INFO - Params: {'apart_id': 864587}
2025-02-12 08:06:17,394 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:06:17,394 - INFO - Params: {}
2025-02-12 08:06:19,095 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:06:19,095 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 08:06:19,559 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:06:19,559 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:06:19,560 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:06:19,560 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:07:55,994 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:07:55,995 - INFO - Params: {}
2025-02-12 08:07:59,741 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:07:59,741 - INFO - Params: {}
2025-02-12 08:08:01,775 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:08:01,776 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 08:08:02,263 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:08:02,263 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:08:02,264 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:08:02,264 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:08:03,734 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:03,734 - INFO - Params: {'apart_id': 864587}
2025-02-12 08:08:09,429 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:09,429 - INFO - Params: {'apart_id': 864919}
2025-02-12 08:08:10,519 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:10,519 - INFO - Params: {'apart_id': 864973}
2025-02-12 08:08:12,326 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:12,326 - INFO - Params: {'apart_id': 864973}
2025-02-12 08:08:13,694 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:13,694 - INFO - Params: {'apart_id': 864973}
2025-02-12 08:08:14,961 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 08:08:14,961 - INFO - Params: {}
2025-02-12 08:08:15,560 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:08:15,560 - INFO - Params: {}
2025-02-12 08:08:16,669 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:08:16,669 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 08:08:17,151 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:08:17,151 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:08:17,152 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:08:17,152 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 08:08:18,509 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:18,509 - INFO - Params: {'apart_id': 864587}
2025-02-12 08:08:19,758 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:19,758 - INFO - Params: {'apart_id': 864877}
2025-02-12 08:08:20,606 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:20,606 - INFO - Params: {'apart_id': 864880}
2025-02-12 09:10:26,502 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:10:26,502 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:10:45,469 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 09:10:45,559 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:10:45,559 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:17:21,341 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:21,341 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:17:23,176 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:23,176 - INFO - Params: {'apart_id': 864973}
2025-02-12 09:17:23,760 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:23,760 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:17:47,824 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:47,824 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:18:38,899 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:38,899 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:18:40,970 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:40,971 - INFO - Params: {'apart_id': 864919}
2025-02-12 09:18:45,746 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:45,746 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:18:47,194 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:47,194 - INFO - Params: {'apart_id': 864880}
2025-02-12 09:18:47,746 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:47,746 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:18:48,194 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:48,195 - INFO - Params: {'apart_id': 864933}
2025-02-12 09:18:49,258 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:49,258 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:18:50,834 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:50,834 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:18:52,755 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864901
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:52,755 - INFO - Params: {'apart_id': 864901}
2025-02-12 09:18:55,707 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:55,707 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:18:59,115 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:59,115 - INFO - Params: {'apart_id': 864933}
2025-02-12 09:19:34,132 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:34,133 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:19:43,333 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:43,334 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:19:44,421 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:44,421 - INFO - Params: {'apart_id': 864919}
2025-02-12 09:19:45,245 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:45,245 - INFO - Params: {'apart_id': 864973}
2025-02-12 09:19:46,013 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:46,014 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:19:49,837 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:49,837 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:19:53,198 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:53,198 - INFO - Params: {'apart_id': 864930}
2025-02-12 09:19:55,478 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864970
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:55,478 - INFO - Params: {'apart_id': 864970}
2025-02-12 09:19:56,757 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864972
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:56,757 - INFO - Params: {'apart_id': 864972}
2025-02-12 09:19:57,805 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864862
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:57,805 - INFO - Params: {'apart_id': 864862}
2025-02-12 09:19:58,869 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865011
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:58,870 - INFO - Params: {'apart_id': 865011}
2025-02-12 09:19:59,998 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864998
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:59,999 - INFO - Params: {'apart_id': 864998}
2025-02-12 09:20:04,326 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865748
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:20:04,326 - INFO - Params: {'apart_id': 865748}
2025-02-12 09:20:05,277 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865453
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:20:05,277 - INFO - Params: {'apart_id': 865453}
2025-02-12 09:20:06,270 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865428
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:20:06,270 - INFO - Params: {'apart_id': 865428}
2025-02-12 09:21:14,944 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:21:14,945 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:21:18,110 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 09:21:18,110 - INFO - Params: {}
2025-02-12 09:21:19,585 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 09:21:19,585 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 09:21:19,928 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 09:21:19,928 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 09:21:19,930 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 09:21:19,930 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 09:23:05,408 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864994
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:23:05,409 - INFO - Params: {'apart_id': 864994}
2025-02-12 09:23:06,339 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864994
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:23:06,339 - INFO - Params: {'apart_id': 864994}
2025-02-12 09:23:41,629 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864838
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:23:41,629 - INFO - Params: {'apart_id': 864838}
2025-02-12 09:24:26,620 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:24:26,621 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:24:50,707 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:24:50,707 - INFO - Params: {'apart_id': 864933}
2025-02-12 09:26:57,164 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:57,165 - INFO - Params: {'apart_id': 864919}
2025-02-12 09:26:58,028 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:58,029 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:26:58,996 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:58,996 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:26:59,636 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:59,636 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:27:53,343 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864916
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:27:53,343 - INFO - Params: {'apart_id': 864916}
2025-02-12 09:27:55,485 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:27:55,485 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:34:37,071 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:37,071 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:34:39,141 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:39,141 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:34:39,932 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:39,933 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:34:40,604 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:40,604 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:42,260 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:42,260 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:46,804 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:46,804 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:48,588 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:48,588 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:54,957 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:54,957 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:34:56,876 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:56,876 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:35:13,958 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:13,958 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:35:15,580 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864893
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:15,580 - INFO - Params: {'apart_id': 864893}
2025-02-12 09:35:17,180 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864893
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:17,181 - INFO - Params: {'apart_id': 864893}
2025-02-12 09:35:18,492 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:18,492 - INFO - Params: {'apart_id': 864997}
2025-02-12 09:35:21,452 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864949
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:21,453 - INFO - Params: {'apart_id': 864949}
2025-02-12 09:35:23,492 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865012
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:23,492 - INFO - Params: {'apart_id': 865012}
2025-02-12 09:35:35,876 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:35,876 - INFO - Params: {'apart_id': 864996}
2025-02-12 10:02:02,255 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:02:02,255 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:02:21,213 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 10:06:00,451 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864894
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:00,452 - INFO - Params: {'apart_id': 864894}
2025-02-12 10:06:01,793 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865029
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:01,793 - INFO - Params: {'apart_id': 865029}
2025-02-12 10:06:04,296 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864840
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:04,296 - INFO - Params: {'apart_id': 864840}
2025-02-12 10:06:19,961 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865671
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:19,961 - INFO - Params: {'apart_id': 865671}
2025-02-12 10:06:21,464 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865671
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:21,464 - INFO - Params: {'apart_id': 865671}
2025-02-12 10:06:22,096 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864608
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:22,096 - INFO - Params: {'apart_id': 864608}
2025-02-12 10:06:22,648 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864769
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:22,648 - INFO - Params: {'apart_id': 864769}
2025-02-12 10:36:59,055 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:36:59,055 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:37:05,632 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:37:05,632 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:37:18,008 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 10:37:18,387 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:37:18,387 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:37:24,570 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 10:37:26,407 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:37:26,407 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:44:39,438 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:44:39,439 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:46:24,677 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:46:24,677 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:53:07,369 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:53:07,370 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:53:37,036 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:53:37,037 - INFO - Params: {'apart_id': 864973}
2025-02-12 10:54:02,086 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:54:02,086 - INFO - Params: {'apart_id': 864877}
2025-02-12 10:54:33,381 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:54:33,381 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:12:09,958 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:09,958 - INFO - Params: {'apart_id': 864918}
2025-02-12 11:12:09,959 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.InterfaceError) <class 'asyncpg.exceptions._base.InterfaceError'>: connection is closed
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/rvf5)
2025-02-12 11:12:11,178 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864970
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:11,178 - INFO - Params: {'apart_id': 864970}
2025-02-12 11:12:12,675 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864837
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:12,675 - INFO - Params: {'apart_id': 864837}
2025-02-12 11:12:14,018 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864837
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:14,019 - INFO - Params: {'apart_id': 864837}
2025-02-12 11:12:14,611 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864856
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:14,611 - INFO - Params: {'apart_id': 864856}
2025-02-12 11:12:15,266 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864861
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:15,266 - INFO - Params: {'apart_id': 864861}
2025-02-12 11:12:15,714 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864870
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:15,714 - INFO - Params: {'apart_id': 864870}
2025-02-12 11:12:17,018 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864979
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:17,018 - INFO - Params: {'apart_id': 864979}
2025-02-12 11:12:17,577 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865020
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:17,577 - INFO - Params: {'apart_id': 865020}
2025-02-12 11:12:18,066 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864840
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:18,066 - INFO - Params: {'apart_id': 864840}
2025-02-12 11:12:18,586 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864955
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:18,587 - INFO - Params: {'apart_id': 864955}
2025-02-12 11:12:19,298 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864981
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:19,299 - INFO - Params: {'apart_id': 864981}
2025-02-12 11:12:20,395 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864981
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:20,395 - INFO - Params: {'apart_id': 864981}
2025-02-12 11:12:21,274 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865026
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:21,275 - INFO - Params: {'apart_id': 865026}
2025-02-12 11:12:22,714 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864983
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:22,714 - INFO - Params: {'apart_id': 864983}
2025-02-12 11:12:25,810 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864908
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:25,810 - INFO - Params: {'apart_id': 864908}
2025-02-12 11:12:30,466 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865388
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:30,466 - INFO - Params: {'apart_id': 865388}
2025-02-12 11:24:56,144 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:24:56,145 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:27:08,062 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 11:27:08,063 - INFO - Params: {}
2025-02-12 11:27:09,061 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 11:27:09,061 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 11:27:09,436 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:27:09,436 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 11:27:09,438 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:27:09,438 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 11:27:12,803 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:27:12,804 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:32:43,866 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:32:43,866 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:32:57,979 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:32:57,979 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:54:03,231 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:54:03,232 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:54:22,168 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 11:56:18,120 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:18,121 - INFO - Params: {'apart_id': 864877}
2025-02-12 11:56:18,383 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:18,383 - INFO - Params: {'apart_id': 865013}
2025-02-12 11:56:18,633 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:18,633 - INFO - Params: {'apart_id': 864933}
2025-02-12 11:56:19,441 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:19,442 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:57:09,729 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:57:09,729 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:57:43,980 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 11:57:43,980 - INFO - Params: {}
2025-02-12 11:57:44,855 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 11:57:44,855 - INFO - Params: {'district_0': 'ƒ∆œ Ë ∆‘ (√‡ÁÂÚÌ˚È ÔÂ.,1/12)'}
2025-02-12 11:57:45,472 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:57:45,472 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-12 11:57:45,486 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:57:45,486 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-12 11:57:46,103 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:57:46,103 - INFO - Params: {'house_address_0': '1-ˇ ∆ÂÎÂÁÌÓ‰ÓÓÊÌ‡ˇ ÛÎËˆ‡, ‰.6', 'municipal_0': 'NaN'}
2025-02-12 11:57:47,111 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:57:47,111 - INFO - Params: {'house_address_0': '1-ˇ ∆ÂÎÂÁÌÓ‰ÓÓÊÌ‡ˇ ÛÎËˆ‡, ‰.6', 'municipal_0': 'NaN'}
2025-02-12 11:57:48,223 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:57:48,223 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-12 11:57:48,225 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:57:48,225 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-12 11:57:49,623 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 11:57:49,623 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 11:57:50,792 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:57:50,792 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 11:57:50,793 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:57:50,794 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 11:57:51,647 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:57:51,647 - INFO - Params: {'apart_id': 864880}
2025-02-12 11:58:21,360 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:58:21,360 - INFO - Params: {'apart_id': 865013}
2025-02-12 11:59:12,764 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:59:12,764 - INFO - Params: {'apart_id': 865013}
2025-02-12 11:59:27,936 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:59:27,936 - INFO - Params: {'apart_id': 864954}
2025-02-12 11:59:29,308 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:59:29,309 - INFO - Params: {'apart_id': 864954}
2025-02-12 12:00:04,933 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:04,933 - INFO - Params: {'apart_id': 864958}
2025-02-12 12:00:06,181 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:06,182 - INFO - Params: {'apart_id': 864958}
2025-02-12 12:00:07,917 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:07,917 - INFO - Params: {'apart_id': 864958}
2025-02-12 12:00:21,987 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:21,987 - INFO - Params: {'apart_id': 864933}
2025-02-12 12:00:22,445 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:22,446 - INFO - Params: {'apart_id': 864954}
2025-02-12 12:00:23,830 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:23,830 - INFO - Params: {'apart_id': 864954}
2025-02-12 12:00:35,423 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:35,423 - INFO - Params: {'apart_id': 865013}
2025-02-12 12:00:36,238 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:36,238 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:37,534 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:37,534 - INFO - Params: {'apart_id': 865013}
2025-02-12 12:00:38,358 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:38,358 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:39,574 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:39,574 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:41,366 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:41,367 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:42,742 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:42,742 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:43,926 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:43,926 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:01:07,225 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:01:07,225 - INFO - Params: {'apart_id': 864973}
2025-02-12 12:59:52,023 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:59:52,024 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:00:10,997 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 13:00:11,051 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:00:11,051 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:00:26,497 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:00:26,498 - INFO - Params: {}
2025-02-12 13:00:39,943 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:00:39,943 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 13:00:40,694 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:00:40,694 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:00:40,712 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:00:40,712 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:00:52,919 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:00:52,919 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:00:54,694 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:00:54,694 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:08:57,420 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:08:57,420 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:09:14,156 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:09:14,156 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:09:59,119 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:09:59,119 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:09:59,923 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:09:59,924 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:10:01,187 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:01,187 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:03,484 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:03,484 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:04,683 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:04,683 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:05,907 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:05,907 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:39,250 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:39,250 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:10:40,596 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:40,596 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:13:54,633 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:13:54,633 - INFO - Params: {}
2025-02-12 13:13:55,867 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:13:55,867 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 13:13:56,259 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:13:56,259 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:13:56,260 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:13:56,260 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:13:57,074 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:13:57,075 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:14:37,963 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:14:37,963 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:14:48,331 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:14:48,331 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:33:29,367 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865029
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:29,368 - INFO - Params: {'apart_id': 865029}
2025-02-12 13:33:29,935 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864855
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:29,935 - INFO - Params: {'apart_id': 864855}
2025-02-12 13:33:30,615 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864931
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:30,616 - INFO - Params: {'apart_id': 864931}
2025-02-12 13:33:31,743 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865012
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:31,743 - INFO - Params: {'apart_id': 865012}
2025-02-12 13:33:33,295 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:33,296 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:33:37,255 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:37,256 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:33:38,511 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:38,512 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:33:39,983 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:39,983 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:33:43,815 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:43,816 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:34:27,919 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:27,920 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:34:29,551 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:29,551 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:34:33,463 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864894
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:33,463 - INFO - Params: {'apart_id': 864894}
2025-02-12 13:34:34,039 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:34,039 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:34:34,455 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:34,455 - INFO - Params: {'apart_id': 864930}
2025-02-12 13:35:15,197 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:15,198 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:35:16,152 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:16,152 - INFO - Params: {'apart_id': 864930}
2025-02-12 13:35:16,992 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:16,992 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:35:17,591 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:17,591 - INFO - Params: {'apart_id': 864930}
2025-02-12 13:35:25,432 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:25,432 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:35:27,119 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864879
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:27,119 - INFO - Params: {'apart_id': 864879}
2025-02-12 13:35:27,887 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864894
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:27,887 - INFO - Params: {'apart_id': 864894}
2025-02-12 13:35:29,774 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:35:29,774 - INFO - Params: {}
2025-02-12 13:35:32,000 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:35:32,000 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 13:35:32,456 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:35:32,456 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:35:32,470 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:35:32,471 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:35:35,871 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:35,871 - INFO - Params: {'apart_id': 864587}
2025-02-12 13:35:58,295 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:35:58,296 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:35:58,312 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:35:58,313 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:36:01,808 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:36:01,808 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:36:01,809 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:36:01,809 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:36:08,165 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:36:08,165 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-12 13:36:08,808 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:36:08,808 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-12 13:36:08,809 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:36:08,809 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-12 13:36:12,959 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:12,959 - INFO - Params: {'apart_id': 720420}
2025-02-12 13:36:14,655 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720451
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:14,655 - INFO - Params: {'apart_id': 720451}
2025-02-12 13:36:15,102 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:15,103 - INFO - Params: {'apart_id': 766514}
2025-02-12 13:36:18,959 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:36:18,960 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:36:18,972 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:36:18,973 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:36:20,671 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:20,671 - INFO - Params: {'apart_id': 864587}
2025-02-12 13:36:25,818 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 13:36:25,818 - INFO - Params: {}
2025-02-12 13:36:27,355 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:36:27,356 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 13:36:28,200 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:36:28,200 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:36:28,226 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:36:28,226 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 13:36:31,959 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 53922
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:36:31,960 - INFO - Params: {'apart_id': 53922}
2025-02-12 13:37:44,206 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 54020
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:44,206 - INFO - Params: {'apart_id': 54020}
2025-02-12 13:37:45,367 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 54157
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:45,367 - INFO - Params: {'apart_id': 54157}
2025-02-12 13:37:46,447 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 53964
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:46,448 - INFO - Params: {'apart_id': 53964}
2025-02-12 13:37:47,231 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 53922
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:47,231 - INFO - Params: {'apart_id': 53922}
2025-02-12 13:41:51,408 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:41:51,408 - INFO - Params: {}
2025-02-12 13:41:53,183 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 13:41:53,183 - INFO - Params: {}
2025-02-12 13:41:59,676 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:41:59,677 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-12 13:42:00,501 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:42:00,501 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-12 13:42:00,513 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:42:00,513 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-12 13:43:02,064 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:43:02,064 - INFO - Params: {}
2025-02-12 13:43:03,062 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 13:43:03,062 - INFO - Params: {}
2025-02-12 13:43:04,263 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:43:04,263 - INFO - Params: {}
2025-02-12 13:43:05,294 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 13:43:05,294 - INFO - Params: {}
2025-02-12 13:43:06,589 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:43:06,589 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-12 13:43:06,854 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:43:06,854 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-12 13:43:06,855 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:43:06,855 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-12 13:43:08,676 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 9051407
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:43:08,676 - INFO - Params: {'apart_id': 9051407}
2025-02-12 13:43:11,205 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 9051407
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:43:11,205 - INFO - Params: {'apart_id': 9051407}
2025-02-12 13:43:16,842 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:43:16,842 - INFO - Params: {}
2025-02-12 13:43:19,244 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:43:19,244 - INFO - Params: {'district_0': '÷ÂÌÚ‡Î¸Ì˚È ¿Œ'}
2025-02-12 13:44:46,296 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 13:44:46,296 - INFO - Params: None
2025-02-12 13:44:46,299 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 13:44:46,299 - INFO - Params: None
2025-02-12 13:44:47,137 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:44:47,138 - INFO - Params: {}
2025-02-12 13:47:43,663 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:47:43,663 - INFO - Params: {}
2025-02-12 14:02:28,495 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:02:28,496 - INFO - Params: {}
2025-02-12 14:03:54,161 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:03:54,162 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-12 14:06:57,860 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:06:57,860 - INFO - Params: {'municipal_districts_0': 'ÕÓ‚Ó„ËÂÂ‚Ó'}
2025-02-12 14:06:57,861 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:06:57,861 - INFO - Params: {'municipal_0': 'ÕÓ‚Ó„ËÂÂ‚Ó'}
2025-02-12 14:06:58,348 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:06:58,348 - INFO - Params: {'house_address_0': '¡‡ÚÒÍ‡ˇ ÛÎ., ‰.23 ÍÓ.2', 'municipal_0': 'ÕÓ‚Ó„ËÂÂ‚Ó'}
2025-02-12 14:08:24,621 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:08:24,622 - INFO - Params: {}
2025-02-12 14:08:46,286 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:08:46,286 - INFO - Params: {}
2025-02-12 14:08:50,180 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:08:50,180 - INFO - Params: {}
2025-02-12 14:11:02,005 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:11:02,006 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 14:11:02,388 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:11:02,388 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 14:11:02,389 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:11:02,389 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 14:32:29,525 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:32:29,525 - INFO - Params: {}
2025-02-12 14:32:36,725 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:32:36,726 - INFO - Params: {}
2025-02-12 14:32:38,858 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:32:38,858 - INFO - Params: {}
2025-02-12 14:32:41,429 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:32:41,429 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 14:32:42,269 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:32:42,269 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 14:32:42,270 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:32:42,270 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 14:32:48,476 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 14:32:55,678 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 14:34:42,474 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:34:42,474 - INFO - Params: {}
2025-02-12 14:34:43,343 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:34:43,343 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-12 14:35:10,647 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:35:10,647 - INFO - Params: {'municipal_districts_0': '»‚‡ÌÓ‚ÒÍÓÂ'}
2025-02-12 14:35:10,790 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:35:10,790 - INFO - Params: {'municipal_0': '»‚‡ÌÓ‚ÒÍÓÂ'}
2025-02-12 14:35:33,056 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:35:33,057 - INFO - Params: {}
2025-02-12 14:41:58,089 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:41:58,089 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 14:41:58,502 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:41:58,503 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 14:41:58,504 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:41:58,504 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 14:42:00,327 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 14:42:00,327 - INFO - Params: {'apart_id': 864880}
2025-02-12 15:42:42,535 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:42,535 - INFO - Params: {}
2025-02-12 15:42:45,830 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 15:42:45,830 - INFO - Params: {}
2025-02-12 15:42:53,224 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:53,224 - INFO - Params: {}
2025-02-12 15:42:53,861 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:53,861 - INFO - Params: {}
2025-02-12 15:42:54,787 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:54,788 - INFO - Params: {}
2025-02-12 15:42:58,926 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 15:42:58,926 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 15:42:59,334 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 15:42:59,334 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 15:42:59,335 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 15:42:59,336 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 15:43:01,471 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:43:04,793 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:43:12,167 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:43:12,824 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:44:03,717 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:44:03,717 - INFO - Params: {}
2025-02-12 15:44:05,542 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 15:44:05,542 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 15:44:06,063 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 15:44:06,063 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 15:44:06,067 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 15:44:06,067 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 16:10:24,179 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:24,179 - INFO - Params: {}
2025-02-12 16:10:26,107 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 16:10:26,107 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-12 16:10:39,170 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:39,171 - INFO - Params: {}
2025-02-12 16:10:40,456 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:40,456 - INFO - Params: {}
2025-02-12 16:10:43,146 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:43,146 - INFO - Params: {}
2025-02-12 16:10:43,588 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:43,588 - INFO - Params: {}
2025-02-12 16:10:45,046 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN ($1)
            ORDER BY municipal_district
        ]
[parameters: ('¬ÓÒÚÓ˜Ì˚È ¿Œ',)]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:10:45,106 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 16:10:45,107 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 16:10:45,642 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 16:10:45,642 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 16:10:45,755 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 16:10:45,755 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 16:10:47,154 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:10:47,155 - INFO - Params: {'apart_id': 864997}
2025-02-12 16:10:57,747 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:10:57,747 - INFO - Params: {'apart_id': 864954}
2025-02-12 16:10:58,109 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:10:59,399 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:11:02,093 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:11:08,882 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:11:08,882 - INFO - Params: None
2025-02-12 16:11:08,886 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:11:08,886 - INFO - Params: None
2025-02-12 16:11:36,504 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:11:36,505 - INFO - Params: {}
2025-02-12 16:11:37,979 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 16:11:37,979 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-12 16:11:38,459 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 16:11:38,459 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 16:11:38,567 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 16:11:38,567 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-12 16:26:19,595 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:26:19,596 - INFO - Params: {'apart_id': 864918}
2025-02-12 16:27:25,937 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:27:25,937 - INFO - Params: {'apart_id': 864587}
2025-02-12 16:31:15,083 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:15,083 - INFO - Params: {'apart_id': 864880}
2025-02-12 16:31:16,163 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:16,163 - INFO - Params: {'apart_id': 864954}
2025-02-12 16:31:19,618 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:19,618 - INFO - Params: {'apart_id': 864587}
2025-02-12 16:31:21,178 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:21,178 - INFO - Params: {'apart_id': 864997}
2025-02-12 16:31:21,746 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:21,746 - INFO - Params: {'apart_id': 864918}
2025-02-12 16:34:04,165 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:34:04,165 - INFO - Params: None
2025-02-12 16:34:04,167 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:34:04,167 - INFO - Params: None
2025-02-13 08:13:18,166 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:13:18,166 - INFO - Params: {}
2025-02-13 08:13:20,073 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:13:20,073 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 08:13:20,657 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:13:20,657 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:13:20,659 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:13:20,659 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:13:32,170 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720438
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:32,170 - INFO - Params: {'apart_id': 720438}
2025-02-13 08:13:35,835 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720477
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:35,835 - INFO - Params: {'apart_id': 720477}
2025-02-13 08:13:41,605 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:41,605 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:13:43,692 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:43,692 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:13:53,034 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:53,034 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:13:54,717 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:54,717 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:13:56,567 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:56,567 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:17:24,836 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:24,836 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:17:33,029 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:33,029 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:17:50,682 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 768979
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:50,682 - INFO - Params: {'apart_id': 768979}
2025-02-13 08:17:55,727 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766335
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:55,727 - INFO - Params: {'apart_id': 766335}
2025-02-13 08:18:05,865 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:05,865 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:18:15,330 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:18:15,330 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 08:18:15,858 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:18:15,858 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:18:15,931 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:18:15,931 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:18:17,956 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:17,956 - INFO - Params: {'apart_id': 864587}
2025-02-13 08:18:30,347 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:30,347 - INFO - Params: {'apart_id': 864954}
2025-02-13 08:18:32,227 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:32,227 - INFO - Params: {'apart_id': 864958}
2025-02-13 08:18:33,413 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864893
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:33,413 - INFO - Params: {'apart_id': 864893}
2025-02-13 08:35:13,968 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:35:13,968 - INFO - Params: {'house_address_0': ' ÛÁÌÂˆÓ‚ÒÍ‡ˇ ÛÎ., ‰.7', 'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:35:16,582 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:35:16,582 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:35:16,583 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:35:16,583 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:35:27,800 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:35:27,800 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:36:44,234 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:36:44,234 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:37:02,192 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:37:02,192 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:37:17,106 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720477
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:37:17,106 - INFO - Params: {'apart_id': 720477}
2025-02-13 08:38:15,436 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:38:15,436 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:38:36,151 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:38:36,151 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:40:06,429 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:40:06,429 - INFO - Params: {}
2025-02-13 08:40:07,145 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:40:07,145 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 08:40:07,551 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:40:07,552 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:40:07,552 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:40:07,553 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:40:56,549 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:40:56,549 - INFO - Params: {}
2025-02-13 08:40:57,242 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:40:57,242 - INFO - Params: {'district_0': 'ƒ∆œ Ë ∆‘ (√‡ÁÂÚÌ˚È ÔÂ.,1/12)'}
2025-02-13 08:40:58,090 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:40:58,090 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 08:40:58,648 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:40:58,648 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:40:58,649 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:40:58,649 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:41:51,753 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766051
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:41:51,753 - INFO - Params: {'apart_id': 766051}
2025-02-13 08:41:53,745 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766051
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:41:53,745 - INFO - Params: {'apart_id': 766051}
2025-02-13 08:41:55,567 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766091
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:41:55,567 - INFO - Params: {'apart_id': 766091}
2025-02-13 08:41:58,271 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:41:58,271 - INFO - Params: {}
2025-02-13 08:41:59,192 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:41:59,192 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 08:41:59,520 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:41:59,520 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:41:59,521 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:41:59,521 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:42:01,300 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:01,300 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:02,917 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:02,917 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:04,565 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:04,565 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:05,835 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:05,835 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:42:08,221 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:08,221 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:10,843 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:10,843 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:12,323 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:12,323 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:13,479 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766506
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:13,479 - INFO - Params: {'apart_id': 766506}
2025-02-13 08:42:28,850 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:28,850 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:31,035 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:31,035 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:39,204 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766506
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:39,204 - INFO - Params: {'apart_id': 766506}
2025-02-13 08:42:41,715 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766335
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:41,715 - INFO - Params: {'apart_id': 766335}
2025-02-13 08:42:43,516 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766335
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:43,516 - INFO - Params: {'apart_id': 766335}
2025-02-13 08:54:45,403 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:54:45,403 - INFO - Params: {}
2025-02-13 08:55:38,676 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:55:38,676 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 08:55:39,123 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:55:39,124 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:55:39,132 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:55:39,132 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:56:23,647 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:56:23,647 - INFO - Params: {}
2025-02-13 08:56:26,068 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:56:26,068 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 08:56:26,835 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:56:26,836 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:56:26,845 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:56:26,845 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:56:53,866 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:56:53,866 - INFO - Params: {}
2025-02-13 08:56:54,628 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:56:54,628 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 08:56:54,964 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:56:54,964 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:56:54,976 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:56:54,976 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:56:55,303 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:56:55,303 - INFO - Params: {'house_address_0': '»ÌÊÂÌÂÌ‡ˇ ÛÎ., ‰ÓÏ 10, ÍÓÔ. 1', 'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:58:20,909 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:58:20,909 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 08:58:21,604 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:58:21,604 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:58:21,605 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:58:21,605 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 08:58:45,899 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:58:45,899 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:58:45,899 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:58:45,899 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 08:59:06,535 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:59:06,535 - INFO - Params: {'apart_id': 864954}
2025-02-13 09:00:44,419 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:00:44,419 - INFO - Params: {}
2025-02-13 09:01:30,054 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:01:30,054 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 09:01:30,758 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:01:30,758 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 09:01:30,762 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:01:30,762 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 09:05:18,929 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 09:05:18,929 - INFO - Params: {'apart_id': 864954}
2025-02-13 09:05:46,642 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 09:05:46,642 - INFO - Params: {'apart_id': 864587}
2025-02-13 09:32:11,045 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:32:11,045 - INFO - Params: {}
2025-02-13 09:32:11,045 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.InterfaceError) <class 'asyncpg.exceptions._base.InterfaceError'>: connection is closed
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/rvf5)
2025-02-13 09:32:55,522 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:32:55,522 - INFO - Params: {}
2025-02-13 09:32:56,095 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:32:56,095 - INFO - Params: {}
2025-02-13 09:32:56,652 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:32:56,652 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 09:32:57,469 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:32:57,469 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:32:57,470 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:32:57,470 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:35:29,869 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:35:29,869 - INFO - Params: {}
2025-02-13 09:42:03,213 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:42:03,213 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 09:42:03,656 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:42:03,656 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:42:03,657 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:42:03,658 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:42:06,996 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:42:06,996 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:42:06,996 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:42:06,996 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:42:08,555 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:42:08,555 - INFO - Params: {}
2025-02-13 09:42:55,695 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:42:55,695 - INFO - Params: {}
2025-02-13 09:43:16,979 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:43:16,979 - INFO - Params: {}
2025-02-13 09:43:17,754 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:43:17,754 - INFO - Params: {}
2025-02-13 09:43:18,418 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:43:18,418 - INFO - Params: {}
2025-02-13 09:43:18,849 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:43:18,849 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 09:43:19,257 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:43:19,257 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:43:19,260 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:19,260 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:43:21,103 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:43:21,103 - INFO - Params: {}
2025-02-13 09:43:22,065 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:43:22,065 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 09:43:22,522 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:22,522 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:43:22,523 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:43:22,523 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 09:43:26,777 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:26,778 - INFO - Params: {'municipal_0': '√ÓÎ¸ˇÌÓ‚Ó'}
2025-02-13 09:43:26,778 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:43:26,779 - INFO - Params: {'municipal_districts_0': '√ÓÎ¸ˇÌÓ‚Ó'}
2025-02-13 09:43:27,329 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:27,329 - INFO - Params: {'house_address_0': '¿ÏÛÒÍ‡ˇ ÛÎ., ‰.1/21', 'municipal_0': '√ÓÎ¸ˇÌÓ‚Ó'}
2025-02-13 09:43:30,537 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:43:30,537 - INFO - Params: {'district_0': '«ÂÎÂÌÓ„‡‰ÒÍËÈ ¿Œ'}
2025-02-13 09:43:31,233 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:31,233 - INFO - Params: {'municipal_0': ' ˛ÍÓ‚Ó'}
2025-02-13 09:43:31,234 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:43:31,234 - INFO - Params: {'municipal_districts_0': ' ˛ÍÓ‚Ó'}
2025-02-13 10:06:24,064 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:06:24,064 - INFO - Params: {}
2025-02-13 10:06:43,003 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 10:07:04,405 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:04,405 - INFO - Params: {}
2025-02-13 10:07:07,408 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:07,408 - INFO - Params: {}
2025-02-13 10:07:10,653 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:10,653 - INFO - Params: {}
2025-02-13 10:07:11,740 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:07:11,740 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 10:07:12,236 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:07:12,236 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 10:07:12,239 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:07:12,239 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 10:07:34,631 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:34,631 - INFO - Params: {}
2025-02-13 10:07:46,705 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:46,705 - INFO - Params: {}
2025-02-13 10:07:50,773 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:50,773 - INFO - Params: {}
2025-02-13 10:25:56,058 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:25:56,059 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 10:25:57,438 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:25:57,438 - INFO - Params: {'municipal_0': '¬ÓÒÚÓ˜ÌÓÂ »ÁÏ‡ÈÎÓ‚Ó'}
2025-02-13 10:25:57,440 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:25:57,440 - INFO - Params: {'municipal_districts_0': '¬ÓÒÚÓ˜ÌÓÂ »ÁÏ‡ÈÎÓ‚Ó'}
2025-02-13 10:25:58,460 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 749909
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:25:58,460 - INFO - Params: {'apart_id': 749909}
2025-02-13 10:26:06,722 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 749909
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:26:06,722 - INFO - Params: {'apart_id': 749909}
2025-02-13 10:28:35,693 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:28:35,693 - INFO - Params: {'municipal_districts_0': '¬ÓÒÚÓ˜ÌÓÂ »ÁÏ‡ÈÎÓ‚Ó'}
2025-02-13 10:28:35,698 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:28:35,698 - INFO - Params: {'municipal_0': '¬ÓÒÚÓ˜ÌÓÂ »ÁÏ‡ÈÎÓ‚Ó'}
2025-02-13 10:28:35,837 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:28:35,837 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 10:28:35,851 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:28:35,851 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 10:28:39,564 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:28:39,564 - INFO - Params: {'apart_id': 720478}
2025-02-13 10:46:38,742 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:46:38,742 - INFO - Params: {}
2025-02-13 10:46:39,408 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:46:39,409 - INFO - Params: {}
2025-02-13 10:46:44,410 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:46:44,410 - INFO - Params: {}
2025-02-13 10:47:29,418 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:47:29,418 - INFO - Params: {}
2025-02-13 10:47:39,787 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:47:39,788 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 10:47:40,818 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:40,818 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:40,820 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:40,820 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:42,369 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:47:42,369 - INFO - Params: {'apart_id': 864587}
2025-02-13 10:47:43,521 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:43,521 - INFO - Params: {'house_address_0': '»ÌÊÂÌÂÌ‡ˇ ÛÎ., ‰ÓÏ 18, ÍÓÔ. 2', 'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:44,800 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:44,800 - INFO - Params: {'house_address_0': '»ÌÊÂÌÂÌ‡ˇ ÛÎ., ‰ÓÏ 20, ÍÓÔ. 1', 'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:46,353 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:46,353 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:46,366 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:46,366 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:46,842 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:46,842 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:46,843 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:46,843 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:47:47,577 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:47:47,577 - INFO - Params: {'apart_id': 864587}
2025-02-13 10:47:48,705 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:47:48,705 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 10:47:50,473 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:50,473 - INFO - Params: {'municipal_districts_0': '¬ÓÒÚÓ˜ÌÓÂ »ÁÏ‡ÈÎÓ‚Ó'}
2025-02-13 10:47:50,475 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:50,475 - INFO - Params: {'municipal_0': '¬ÓÒÚÓ˜ÌÓÂ »ÁÏ‡ÈÎÓ‚Ó'}
2025-02-13 10:47:51,594 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 749909
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:47:51,594 - INFO - Params: {'apart_id': 749909}
2025-02-13 10:48:45,732 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:48:45,732 - INFO - Params: {}
2025-02-13 10:48:46,641 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:48:46,642 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 10:48:47,241 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:48:47,241 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 10:48:47,242 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:48:47,242 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 10:48:49,397 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 10:48:49,397 - INFO - Params: {}
2025-02-13 10:49:03,297 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:49:03,297 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 10:49:03,882 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:49:03,882 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:03,884 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:03,884 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:04,437 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:04,437 - INFO - Params: {'house_address_0': '¿ÎÚÛÙ¸Â‚ÒÍÓÂ ¯ÓÒÒÂ, ‰. 53, ÍÓÔ. 1', 'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:05,506 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:05,507 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:05,507 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:49:05,507 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:06,002 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:49:06,002 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:06,004 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:06,004 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:06,906 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 53922
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:49:06,906 - INFO - Params: {'apart_id': 53922}
2025-02-13 10:49:07,922 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:07,922 - INFO - Params: {'house_address_0': '¿ÎÚÛÙ¸Â‚ÒÍÓÂ ¯ÓÒÒÂ, ‰. 53, ÍÓÔ. 1', 'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 10:49:09,737 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 54503
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:49:09,737 - INFO - Params: {'apart_id': 54503}
2025-02-13 10:50:07,658 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:50:07,659 - INFO - Params: {}
2025-02-13 10:50:12,956 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:50:12,957 - INFO - Params: None
2025-02-13 10:50:13,155 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:50:13,155 - INFO - Params: None
2025-02-13 10:50:24,190 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:50:24,190 - INFO - Params: {}
2025-02-13 10:50:24,951 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 10:50:24,951 - INFO - Params: {}
2025-02-13 11:04:48,479 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:04:48,479 - INFO - Params: {}
2025-02-13 11:04:49,769 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:04:49,769 - INFO - Params: {'district_0': '—Â‚ÂÌ˚È ¿Œ'}
2025-02-13 11:04:52,000 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:04:52,000 - INFO - Params: {'district_0': 'ƒ∆œ Ë ∆‘ (√‡ÁÂÚÌ˚È ÔÂ.,1/12)'}
2025-02-13 11:04:55,072 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:04:55,072 - INFO - Params: {'municipal_districts_0': '¿˝ÓÔÓÚ'}
2025-02-13 11:04:55,073 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:04:55,073 - INFO - Params: {'municipal_0': '¿˝ÓÔÓÚ'}
2025-02-13 11:07:01,568 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:07:01,568 - INFO - Params: {}
2025-02-13 11:07:02,127 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:07:02,127 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 11:16:52,394 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:16:52,395 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 11:16:52,396 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:16:52,396 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 11:16:52,856 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:16:52,857 - INFO - Params: {'house_address_0': ' ÛÁÌÂˆÓ‚ÒÍ‡ˇ ÛÎ., ‰.7', 'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 11:16:54,397 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:16:54,397 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 11:16:54,399 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:16:54,399 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 11:20:48,829 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:20:48,829 - INFO - Params: {}
2025-02-13 11:20:49,287 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:20:49,287 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 11:20:51,893 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:20:51,894 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 11:20:51,895 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:20:51,895 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 11:51:58,076 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:51:58,076 - INFO - Params: {}
2025-02-13 11:52:04,937 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:52:04,937 - INFO - Params: {}
2025-02-13 11:52:06,458 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:52:06,458 - INFO - Params: {}
2025-02-13 11:52:17,014 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 11:52:23,875 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:11:18,453 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:11:18,454 - INFO - Params: {'district_0': 'ÕÓ‚ÓÏÓÒÍÓ‚ÒÍËÈ ¿Œ'}
2025-02-13 13:11:18,909 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:11:18,910 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 13:11:20,134 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:11:20,134 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:11:20,249 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:11:20,249 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:11:20,621 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:11:20,622 - INFO - Params: {'district_0': 'ÕÓ‚ÓÏÓÒÍÓ‚ÒÍËÈ ¿Œ'}
2025-02-13 13:11:22,182 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:11:22,182 - INFO - Params: {'apart_id': 864587}
2025-02-13 13:12:36,401 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:12:36,402 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 13:12:39,981 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:39,981 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 13:12:39,982 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:39,982 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 13:12:48,295 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:48,296 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:12:48,297 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:48,297 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:12:48,619 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:48,619 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:12:48,623 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:48,623 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:12:49,341 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:49,341 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:12:49,342 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:49,342 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 13:12:55,630 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864915
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:12:55,630 - INFO - Params: {'apart_id': 864915}
2025-02-13 13:34:27,061 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:34:27,061 - INFO - Params: {'apart_id': 864877}
2025-02-13 13:34:29,192 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:34:29,193 - INFO - Params: {'apart_id': 864587}
2025-02-13 13:34:32,261 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:34:32,262 - INFO - Params: {'apart_id': 864973}
2025-02-13 13:34:45,996 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:34:48,130 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:34:51,227 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:40:21,062 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:40:21,062 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:07:56,115 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:07:56,116 - INFO - Params: {'apart_id': 864918}
2025-02-13 14:08:23,857 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:08:23,857 - INFO - Params: {}
2025-02-13 14:08:26,270 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:08:26,270 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 14:08:35,565 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:08:35,565 - INFO - Params: {}
2025-02-13 14:08:36,732 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:08:36,732 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 14:08:37,501 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:08:37,501 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 14:08:37,502 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:08:37,502 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 14:08:45,207 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN ($1)
            ORDER BY municipal_district
        ]
[parameters: ('¬ÓÒÚÓ˜Ì˚È ¿Œ',)]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 14:08:51,488 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:08:51,488 - INFO - Params: {'apart_id': 720420}
2025-02-13 14:09:09,368 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766506
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:09,368 - INFO - Params: {'apart_id': 766506}
2025-02-13 14:09:12,197 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:12,197 - INFO - Params: {'apart_id': 766514}
2025-02-13 14:09:13,673 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:13,673 - INFO - Params: {'apart_id': 720420}
2025-02-13 14:09:20,818 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:09:20,818 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 14:09:20,818 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:09:20,818 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 14:09:23,949 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:09:23,949 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 14:09:24,589 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:09:24,590 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:09:24,591 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:09:24,591 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:09:25,787 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:25,787 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:09:38,718 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:38,718 - INFO - Params: {'apart_id': 864919}
2025-02-13 14:09:43,055 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:43,055 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:11:16,375 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:11:16,375 - INFO - Params: {}
2025-02-13 14:11:17,534 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:11:17,534 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 14:11:18,094 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:11:18,095 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:11:18,097 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:11:18,097 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:11:19,363 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:11:19,363 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:20:14,606 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:20:14,606 - INFO - Params: {}
2025-02-13 14:20:16,733 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:20:16,733 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 14:20:17,605 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:20:17,605 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:20:17,607 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:20:17,607 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:20:28,971 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864879
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:20:28,971 - INFO - Params: {'apart_id': 864879}
2025-02-13 14:20:31,304 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864879
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:20:31,304 - INFO - Params: {'apart_id': 864879}
2025-02-13 14:21:55,324 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:21:55,324 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 14:21:56,233 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:21:56,233 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 14:21:56,233 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:21:56,233 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 14:28:47,223 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:28:47,223 - INFO - Params: {}
2025-02-13 14:31:30,725 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:31:30,725 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 14:31:31,136 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:31:31,136 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:31:31,137 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:31:31,137 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:31:32,792 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:31:32,792 - INFO - Params: {'apart_id': 864919}
2025-02-13 14:32:53,438 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:32:53,438 - INFO - Params: {}
2025-02-13 14:32:55,497 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:32:55,497 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 14:32:56,417 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:32:56,417 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:32:56,418 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:32:56,418 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:32:57,241 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:32:57,241 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:32:57,242 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:32:57,243 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:32:58,897 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:32:58,897 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:32:58,898 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:32:58,898 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 14:33:46,454 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:33:46,454 - INFO - Params: {}
2025-02-13 14:49:46,560 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:49:46,560 - INFO - Params: None
2025-02-13 14:49:46,560 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:49:46,560 - INFO - Params: None
2025-02-13 15:33:02,220 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 15:33:02,220 - INFO - Params: {}
2025-02-13 15:33:02,498 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 15:33:02,499 - INFO - Params: {}
2025-02-13 15:33:21,165 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 15:33:21,220 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 15:33:21,221 - INFO - Params: {}
2025-02-13 15:33:21,639 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 15:35:37,775 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:35:37,775 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 15:35:39,236 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:35:39,236 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 15:35:39,241 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:35:39,242 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 15:36:55,060 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:36:55,060 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 15:36:55,436 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:36:55,436 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:36:55,437 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:36:55,437 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:05,787 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:05,787 - INFO - Params: {'apart_id': 864880}
2025-02-13 15:37:10,069 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:10,069 - INFO - Params: {'house_address_0': '»ÌÊÂÌÂÌ‡ˇ ÛÎ., ‰ÓÏ 18, ÍÓÔ. 1', 'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:12,194 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:12,194 - INFO - Params: {'house_address_0': '»ÌÊÂÌÂÌ‡ˇ ÛÎ., ‰ÓÏ 10, ÍÓÔ. 1', 'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:14,020 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:37:14,020 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:14,021 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:14,022 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:15,037 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:15,037 - INFO - Params: {'apart_id': 864587}
2025-02-13 15:37:21,523 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:37:21,523 - INFO - Params: {'district_0': '÷ÂÌÚ‡Î¸Ì˚È ¿Œ'}
2025-02-13 15:37:24,221 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:37:24,221 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:24,222 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:24,223 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:24,613 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:37:24,613 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:24,614 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:24,614 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 15:37:25,535 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:25,535 - INFO - Params: {'apart_id': 864587}
2025-02-13 15:37:46,178 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:46,179 - INFO - Params: {'apart_id': 864587}
2025-02-13 15:38:03,404 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:38:03,404 - INFO - Params: {'apart_id': 864877}
2025-02-13 16:21:31,937 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:21:31,937 - INFO - Params: {}
2025-02-13 16:21:32,968 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:21:32,969 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 16:21:36,138 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 16:21:36,138 - INFO - Params: {}
2025-02-13 16:21:36,392 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:21:36,392 - INFO - Params: {}
2025-02-13 16:21:37,162 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:21:37,162 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 16:21:37,658 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:21:37,658 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 16:21:37,659 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:21:37,659 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 16:21:49,030 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 16:21:49,030 - INFO - Params: {}
2025-02-13 16:21:50,861 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 16:21:52,104 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN ($1)
            ORDER BY municipal_district
        ]
[parameters: ('¬ÓÒÚÓ˜Ì˚È ¿Œ',)]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 16:21:55,077 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 16:21:59,953 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:21:59,953 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-13 16:22:00,465 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:22:00,465 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 16:22:00,577 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:22:00,577 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 16:22:01,026 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:22:01,026 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 16:22:01,030 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:22:01,030 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-13 16:22:02,353 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 16:22:02,353 - INFO - Params: {'apart_id': 865013}
2025-02-13 16:22:06,681 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 16:22:06,681 - INFO - Params: {'apart_id': 864880}
2025-02-13 16:29:58,601 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 16:29:58,601 - INFO - Params: {}
2025-02-13 16:29:59,642 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:29:59,642 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-13 16:30:00,082 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:30:00,082 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 16:30:00,083 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:30:00,083 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-13 16:31:43,105 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:31:43,105 - INFO - Params: {'district_0': '“ÓËˆÍËÈ ¿Œ'}
