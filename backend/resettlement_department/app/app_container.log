2025-02-11 12:06:49,942 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,942 - INFO - Params: None
2025-02-11 12:06:49,944 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,944 - INFO - Params: None
2025-02-11 12:06:57,862 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 12:06:57,862 - INFO - Начало загрузки файла
2025-02-11 12:06:57,862 - INFO - Файл для загрузки: ./uploads/container_46.xlsx
2025-02-11 12:06:57,862 - INFO - Файл подготовлен: {'file': ('container_46.xlsx', <_io.BufferedReader name='./uploads/container_46.xlsx'>, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')}
2025-02-11 12:06:57,880 - ERROR - Произошла ошибка: HTTPConnectionPool(host='webspd.mlc.gov', port=80): Max retries exceeded with url: /SpdRemote/spdremotemvc/MassStart/Parse (Caused by NameResolutionError("<urllib3.connection.HTTPConnection object at 0x787bb6026b60>: Failed to resolve 'webspd.mlc.gov' ([Errno -5] No address associated with hostname)"))
2025-02-11 14:10:50,051 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:11:14,343 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:11:33,113 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:11:46,398 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:13:15,916 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:14:59,871 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:15:26,384 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:17:07,660 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:21:04,342 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:22:06,282 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:23:46,092 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:24:10,693 - INFO - Excel файл './uploads/container_46.xlsx' создан.
2025-02-11 14:27:00,721 - INFO - Excel файл './uploads/container_46.xlsx' создан.
