2025-02-17 11:42:00,291 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:00,291 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-17 11:42:00,967 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:00,967 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-17 11:42:01,885 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 53740
                    
2025-02-17 11:42:01,885 - INFO - Params: {'apart_id': 53740}
2025-02-17 11:42:03,145 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 11:42:03,145 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-17 11:42:03,885 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 11:42:03,885 - INFO - Params: {'municipal_districts_0': 'Внуковское сельское поселение'}
2025-02-17 11:42:03,887 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:03,887 - INFO - Params: {'municipal_0': 'Внуковское сельское поселение'}
2025-02-17 11:42:04,347 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:04,347 - INFO - Params: {'house_address_0': 'Анны Ахматовой ул. (п.Внуковское), д.10', 'municipal_0': 'Внуковское сельское поселение'}
2025-02-17 11:42:04,775 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8006871
                    
2025-02-17 11:42:04,775 - INFO - Params: {'apart_id': 8006871}
2025-02-17 12:01:37,588 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 12:01:37,588 - INFO - Params: {}
